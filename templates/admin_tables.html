{% extends 'layout.html' %}
{% block title %}å“ç®¡ç†{% endblock %}
{% block extra_css %}{% endblock %}
{% block content %}
<div class="container" style="max-width: 1200px;">
    <h1 class="mb-4" style="font-size: 2.5rem;">ğŸª‘ å“ç®¡ç†</h1>
    <div class="card mb-4">
        <div class="card-body">
            <form id="add-table-form" class="row g-2 align-items-end">
                <div class="col"><input type="text" id="new_table_name" class="form-control" placeholder="æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«å" required></div>
                <div class="col-auto"><button type="submit" class="btn btn-primary">è¿½åŠ </button></div>
            </form>
        </div>
    </div>
    <div class="row" id="tables-grid">
        {% for table in tables %}
        <div class="col-md-6 col-lg-4 mb-4" id="table-card-{{ table.id }}">
            <div class="card h-100">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ table.name }}</h5>
                    <button type="button" class="btn-close" onclick="deleteTable({{ table.id }})"></button>
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                    <div id="qrcode-{{ table.id }}" class="mb-2" style="min-height: 160px;"></div>
                    <small class="text-muted" id="expiry-{{ table.id }}">
                        {% if table.qr_token_expiry %}{{ table.qr_token_expiry.astimezone(JST).strftime('æœ‰åŠ¹æœŸé™: %H:%M') }}{% endif %}
                    </small>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshToken({{ table.id }})">æ›´æ–°</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="enlargeQR('{{ table.name }}', '{{ table.active_qr_token if table.active_qr_token else 'None' }}')">æ‹¡å¤§</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div class="modal fade" id="qr-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="qr-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body d-flex justify-content-center" id="qr-modal-body"></div></div></div></div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    // APIã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•° (HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒOKã§ãªã„å ´åˆã®ã¿å‘¼ã³å‡ºã™)
    const handleHttpError = async (response) => {
        // 401 Unauthorized ã®å ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        if (response.status === 401) {
            alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            window.location.href = '/login';
            return true; // ã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™
        }

        console.error('API HTTPã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
        try {
            const errorData = await response.json();
            console.error('API HTTPã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿:', errorData);
            alert(`ã‚¨ãƒ©ãƒ¼: ${errorData.message || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'}`);
        } catch (e) {
            console.error('HTTPã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', e);
            alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
        return true; // ã‚¨ãƒ©ãƒ¼ãŒå‡¦ç†ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™
    };

    function generateQRCode(containerId, token, size = 150) {
        const qrContainer = document.getElementById(containerId);
        if (!qrContainer) {
            console.error(`QR Code container not found: ${containerId}`);
            return;
        }
        qrContainer.innerHTML = '';
        if (token && token !== 'None') { // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ãªå ´åˆã«ã®ã¿QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            try {
                new QRCode(qrContainer, { text: `${window.location.origin}/qr/${token}`, width: size, height: size, correctLevel: QRCode.CorrectLevel.H });
                console.log(`QR Code generated for container: ${containerId}, token: ${token}`);
            } catch (qrError) {
                console.error(`Error generating QR Code for ${containerId} with token ${token}:`, qrError);
                qrContainer.innerHTML = '<div class="text-muted small">QRç”Ÿæˆã‚¨ãƒ©ãƒ¼</div>';
            }
        } else {
            console.warn(`Attempted to generate QR with invalid token for container: ${containerId}. Token: ${token}`);
            qrContainer.innerHTML = '<div class="text-muted small">QRæœªç”Ÿæˆ</div>';
        }
    }

    // æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦è¿½åŠ ã™ã‚‹é–¢æ•°
    function addTableCard(table) {
        try {
            const tablesGrid = document.getElementById('tables-grid');
            if (!tablesGrid) {
                console.error('Tables grid container #tables-grid not found.');
                return;
            }

            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-6 col-lg-4 mb-4';
            colDiv.id = `table-card-${table.id}`;

            const expiryText = table.expiry ? `æœ‰åŠ¹æœŸé™: ${new Date(table.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}` : '';
            // Ensure token is a string for JS, 'None' is a string from Jinja template if token is None.
            const tokenForEnlarge = table.token ? `'${table.token}'` : `'None'`; 

            colDiv.innerHTML = `
                <div class="card h-100">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${table.name}</h5>
                        <button type="button" class="btn-close" onclick="deleteTable(${table.id})"></button>
                    </div>
                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                        <div id="qrcode-${table.id}" class="mb-2" style="min-height: 160px;"></div>
                        <small class="text-muted" id="expiry-${table.id}">
                            ${expiryText}
                        </small>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100">
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshToken(${table.id})">æ›´æ–°</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enlargeQR('${table.name}', ${tokenForEnlarge})">æ‹¡å¤§</button>
                        </div>
                    </div>
                </div>
            `;
            tablesGrid.appendChild(colDiv);
            console.log(`Table card for ${table.name} (ID: ${table.id}) appended to DOM.`);

            // Call generateQRCode after the element is in the DOM
            generateQRCode(`qrcode-${table.id}`, table.token); 
            console.log(`addTableCard completed for ${table.name} (ID: ${table.id}).`);

        } catch (jsError) {
            console.error(`Error in addTableCard for table ${table.name} (ID: ${table.id}):`, jsError);
            alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }

    async function refreshToken(tableId) {
        try {
            const response = await fetch(`/api/qr/generate/${tableId}`, { method: 'POST' });
            // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒOKã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™
            if (!response.ok) {
                await handleHttpError(response);
                return; // å‡¦ç†ã‚’ä¸­æ–­
            }

            const data = await response.json();
            if (data.success) {
                generateQRCode(`qrcode-${tableId}`, data.token);

 // â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜…
            // JSTã¨ã—ã¦æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const expiryDate = new Date(data.expiry);
            const expiryText = new Intl.DateTimeFormat('ja-JP', {
                timeZone: 'Asia/Tokyo',
                hour: '2-digit',
                minute: '2-digit'
            }).format(expiryDate);

            document.getElementById(`expiry-${tableId}`).textContent = `æœ‰åŠ¹æœŸé™: ${expiryText}`;
// â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

                document.getElementById(`expiry-${tableId}`).textContent = `æœ‰åŠ¹æœŸé™: ${new Date(data.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}`;
                const card = document.getElementById(`table-card-${tableId}`);
                const tableName = card.querySelector('h5').textContent;
                card.querySelector(`[onclick^="enlargeQR"]`).setAttribute('onclick', `enlargeQR('${tableName}', '${data.token}')`);
                alert('QRã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
                console.log('QRã‚³ãƒ¼ãƒ‰æ›´æ–°æˆåŠŸ:', data);
            } else {
                alert(data.message || 'QRã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('QRã‚³ãƒ¼ãƒ‰æ›´æ–°å¤±æ•— (APIè«–ç†ã‚¨ãƒ©ãƒ¼):', data);
            }
        } catch(error) { 
            console.error('QRã‚³ãƒ¼ãƒ‰æ›´æ–°å‡¦ç†ä¸­ã«é€šä¿¡ã¾ãŸã¯ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
            alert('QRã‚³ãƒ¼ãƒ‰ã®æ›´æ–°ä¸­ã«é€šä¿¡ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); 
        }
    }

    async function deleteTable(tableId) {
        if (!confirm('æœ¬å½“ã«ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        try {
            const response = await fetch(`/api/tables/${tableId}`, { method: 'DELETE' });
            // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒOKã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™
            if (!response.ok) {
                await handleHttpError(response);
                return; // å‡¦ç†ã‚’ä¸­æ–­
            }

            // DELETEã¯é€šå¸¸æˆåŠŸæ™‚ã«dataã‚’è¿”ã•ãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€response.okã§åˆ¤æ–­
            // ã“ã“ã«åˆ°é”ã—ãŸæ™‚ç‚¹ã§response.okã¯true
            const data = await response.json().catch(() => ({ success: true })); // JSONãŒãªã„å ´åˆã‚‚è€ƒæ…®
            if (data.success) {
                document.getElementById(`table-card-${tableId}`).remove();
                alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                console.log('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤æˆåŠŸ:', tableId);
            } else {
                alert(data.message || 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤å¤±æ•— (APIè«–ç†ã‚¨ãƒ©ãƒ¼):', data);
            }
        } catch (error) { 
            console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤å‡¦ç†ä¸­ã«é€šä¿¡ã¾ãŸã¯DOMæ“ä½œã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ä¸­ã«é€šä¿¡ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); 
        }
    }

    document.getElementById('add-table-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('ã€Œè¿½åŠ ã€ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚');
        const name = document.getElementById('new_table_name').value;
        try {
            const response = await fetch('/api/tables', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            
            // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒOKã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™
            if (!response.ok) {
                await handleHttpError(response);
                return; // å‡¦ç†ã‚’ä¸­æ–­
            }

            const data = await response.json();
            if (data.success) {
                alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
                addTableCard(data); // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
                document.getElementById('new_table_name').value = ''; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                console.log('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ æˆåŠŸ:', data);
            } else {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ200 OKã‚’è¿”ã—ãŸãŒã€è«–ç†çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                alert(data.message || 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ å¤±æ•— (APIè«–ç†ã‚¨ãƒ©ãƒ¼):', data);
            }
        } catch (error) { 
            console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ å‡¦ç†ä¸­ã«é€šä¿¡ã¾ãŸã¯ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ ä¸­ã«é€šä¿¡ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); 
        }
    });

    function enlargeQR(tableName, token) {
        if (!token || token === 'None') { alert('å…ˆã«QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã—ã¦ãã ã•ã„ã€‚'); return; }
        document.getElementById('qr-modal-title').textContent = `${tableName} QRã‚³ãƒ¼ãƒ‰`;
        generateQRCode('qr-modal-body', token, 300);
        new bootstrap.Modal(document.getElementById('qr-modal')).show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        {% for table in tables %}
            // åˆæœŸè¡¨ç¤ºæ™‚ã«active_qr_tokenãŒå­˜åœ¨ã™ã‚Œã°QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            generateQRCode('qrcode-{{ table.id }}', '{{ table.active_qr_token if table.active_qr_token else 'None' }}');
        {% endfor %}
    });
</script>
{% endblock %}