{% extends 'layout.html' %}
{% block title %}卓管理{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for table in tables %}
            {% if table.active_qr_token %}
                generateQRCode({{ table.id }}, '{{ table.active_qr_token }}');
            {% endif %}
        {% endfor %}
    });

    function generateQRCode(tableId, token, size = 150, containerId = `qrcode-${tableId}`) {
        const qrContainer = document.getElementById(containerId);
        if (!qrContainer) return;
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: `${window.location.origin}/qr/${token}`,
            width: size,
            height: size,
        });
    }

    async function refreshToken(tableId) {
        try {
            const response = await fetch(`/api/qr/generate/${tableId}`, { method: 'POST' });
            
            // ★★★ 修正点: 401エラー（セッション切れ）のハンドリングを追加 ★★★
            if (response.status === 401) {
                alert('セッションが切れました。再度ログインしてください。');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('QRコードの更新に失敗しました。');
            }
            
            const data = await response.json();
            if (data.success) {
                generateQRCode(tableId, data.token);
                document.getElementById(`expiry-${tableId}`).textContent = `有効期限: ${new Date(data.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}`;
                const card = document.getElementById(`table-card-${tableId}`);
                const tableName = card.querySelector('.card-title').textContent;
                card.querySelector(`[onclick^="enlargeQR"]`).setAttribute('onclick', `enlargeQR('${tableName}', '${data.token}')`);
                card.querySelector(`[onclick^="printQR"]`).setAttribute('onclick', `printQR('${tableName}', '${data.token}')`);
            } else {
                alert(data.message || 'QRコードの更新に失敗しました。');
            }
        } catch(error) {
            alert(error.message);
        }
    }

    // ... (以降の関数は変更なし) ...
</script>
{% endblock %}