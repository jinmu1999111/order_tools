{% extends 'layout.html' %}

{% block title %}ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</h1>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ </h2>
        <form action="{{ url_for('add_table') }}" method="POST" class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-grow">
                <label for="table-name" class="block text-sm font-medium text-gray-700 mb-1">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
                <input type="text" id="table-name" name="name" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
                <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition duration-300 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
                </button>
            </div>
        </form>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¨QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="table-grid">
            {% for table in tables %}
            <div class="table-card bg-gray-50 rounded-lg shadow-sm p-4 border border-gray-200 flex flex-col items-center justify-between text-center" data-table-id="{{ table.id }}" data-table-name="{{ table.name }}" data-table-status="{{ table.status }}">
                <h3 class="text-lg font-bold text-gray-800 mb-2">{{ table.name }}</h3>
                <div class="text-sm font-medium mb-3">
                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
                    <span class="px-2 py-1 rounded-full text-white text-xs {% if table.status == 'available' %}bg-green-500{% elif table.status == 'occupied' %}bg-red-500{% else %}bg-blue-500{% endif %}">
                        {% if table.status == 'available' %}ç©ºã{% elif table.status == 'occupied' %}ä½¿ç”¨ä¸­{% else %}æ¸…æƒä¸­{% endif %}
                    </span>
                </div>

                <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="qr-code-container w-32 h-32 bg-white p-2 rounded-md border border-gray-300 flex items-center justify-center mb-4">
                    <div id="qrcode-{{ table.id }}"></div>
                </div>

                <div class="flex flex-wrap justify-center gap-2 w-full">
                    <button onclick="generateAndPrintQR({{ table.id }}, '{{ table.name }}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition duration-300 flex items-center">
                        <i class="fas fa-qrcode mr-1"></i> QRå°åˆ·
                    </button>
                    <button onclick="openStatusModal({{ table.id }}, '{{ table.name }}', '{{ table.status }}')" class="bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition duration-300 flex items-center">
                        <i class="fas fa-sync-alt mr-1"></i> çŠ¶æ…‹å¤‰æ›´
                    </button>
                    <button onclick="confirmDeleteTable({{ table.id }}, '{{ table.name }}')" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-300 flex items-center">
                        <i class="fas fa-trash-alt mr-1"></i> å‰Šé™¤
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³è¡¨ç¤º (Canvas) -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³</h2>
        <div class="flex justify-center items-center bg-gray-100 rounded-lg p-4">
            <canvas id="floorPlanCanvas" class="border border-gray-300 rounded-md w-full max-w-full h-96"></canvas>
        </div>
        <div class="mt-4 text-center text-gray-600">
            <p>ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</p>
            <button id="save-floor-plan" class="mt-4 bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition duration-300">
                <i class="fas fa-save mr-2"></i> ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜
            </button>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</h2>
        <p id="status-modal-table-name" class="text-lg text-gray-700 mb-4 font-semibold"></p>
        <form id="update-status-form" method="POST">
            <input type="hidden" id="status-modal-table-id" name="table_id">
            <div class="mb-6">
                <label for="new-status" class="block text-sm font-medium text-gray-700 mb-1">æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                <select id="new-status" name="status" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="available">ç©ºã</option>
                    <option value="occupied">ä½¿ç”¨ä¸­</option>
                    <option value="cleaning">æ¸…æƒä¸­</option>
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeStatusModal()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-primary-dark transition duration-300">æ›´æ–°</button>
            </div>
        </form>
    </div>
</div>

<!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="confirm-dialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ç¢ºèª</h2>
        <p id="confirm-message" class="text-gray-700 mb-6">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeConfirmDialog()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" id="confirm-action-button" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300">å‰Šé™¤</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode.js/qrcode.min.js"></script>
<script>
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã®å®šç¾©
    const colors = {
        primary: '#667eea',
        secondary: '#ff6b6b',
        success: '#2ed573',
        warning: '#ffa502',
        error: '#ff4757',
        gray: '#e2e8f0'
    };

    let floorPlanCanvas;
    let ctx;
    let tablesData = []; // ãƒ†ãƒ¼ãƒ–ãƒ«ã®é…ç½®æƒ…å ±ã‚’ä¿æŒ
    let draggingTable = null;
    let offsetX, offsetY;

    document.addEventListener('DOMContentLoaded', function() {
        // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        document.querySelectorAll('.table-card').forEach(card => {
            const tableId = card.dataset.tableId;
            const tableName = card.dataset.tableName;
            // QRã‚³ãƒ¼ãƒ‰ã®URLã¯ã€Flaskã®qr_authã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡ã™
            const qrUrl = `${window.location.origin}/qr/temp_token_for_${tableName}`; // ä»®ã®ãƒˆãƒ¼ã‚¯ãƒ³å
            // å®Ÿéš›ã«ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€QRTokenãƒ¢ãƒ‡ãƒ«ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            // ä¾‹: `/qr/{{ table.qr_token }}` ã®ã‚ˆã†ã«Flaskå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™

            new QRCode(document.getElementById(`qrcode-${tableId}`), {
                text: qrUrl,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });

        // ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³Canvasã®åˆæœŸåŒ–
        floorPlanCanvas = document.getElementById('floorPlanCanvas');
        ctx = floorPlanCanvas.getContext('2d');

        // Canvasã®ã‚µã‚¤ã‚ºã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã¦èª¿æ•´
        function resizeCanvas() {
            floorPlanCanvas.width = floorPlanCanvas.offsetWidth;
            floorPlanCanvas.height = floorPlanCanvas.offsetHeight;
            drawFloorPlan();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œ

        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—ï¼‰
        document.querySelectorAll('.table-card').forEach(card => {
            tablesData.push({
                id: card.dataset.tableId,
                name: card.dataset.tableName,
                status: card.dataset.tableStatus,
                x: Math.random() * (floorPlanCanvas.width - 80), // ãƒ©ãƒ³ãƒ€ãƒ ãªåˆæœŸä½ç½®
                y: Math.random() * (floorPlanCanvas.height - 80),
                width: 80,
                height: 80
            });
        });
        drawFloorPlan();

        // Canvasã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        floorPlanCanvas.addEventListener('mousedown', (e) => {
            const rect = floorPlanCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            for (let i = tablesData.length - 1; i >= 0; i--) {
                const table = tablesData[i];
                if (mouseX > table.x && mouseX < table.x + table.width &&
                    mouseY > table.y && mouseY < table.y + table.height) {
                    draggingTable = table;
                    offsetX = mouseX - table.x;
                    offsetY = mouseY - table.y;
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æœ€å‰é¢ã«
                    tablesData.splice(i, 1);
                    tablesData.push(table);
                    drawFloorPlan();
                    break;
                }
            }
        });

        floorPlanCanvas.addEventListener('mousemove', (e) => {
            if (draggingTable) {
                const rect = floorPlanCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                draggingTable.x = mouseX - offsetX;
                draggingTable.y = mouseY - offsetY;

                // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
                draggingTable.x = Math.max(0, Math.min(draggingTable.x, floorPlanCanvas.width - draggingTable.width));
                draggingTable.y = Math.max(0, Math.min(draggingTable.y, floorPlanCanvas.height - draggingTable.height));

                drawFloorPlan();
            }
        });

        floorPlanCanvas.addEventListener('mouseup', () => {
            draggingTable = null;
        });

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ
        floorPlanCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            const touch = e.touches[0];
            const rect = floorPlanCanvas.getBoundingClientRect();
            const touchX = touch.clientX - rect.left;
            const touchY = touch.clientY - rect.top;

            for (let i = tablesData.length - 1; i >= 0; i--) {
                const table = tablesData[i];
                if (touchX > table.x && touchX < table.x + table.width &&
                    touchY > table.y && touchY < table.y + table.height) {
                    draggingTable = table;
                    offsetX = touchX - table.x;
                    offsetY = touchY - table.y;
                    tablesData.splice(i, 1);
                    tablesData.push(table);
                    drawFloorPlan();
                    break;
                }
            }
        });

        floorPlanCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            if (draggingTable) {
                const touch = e.touches[0];
                const rect = floorPlanCanvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;

                draggingTable.x = touchX - offsetX;
                draggingTable.y = touchY - offsetY;

                draggingTable.x = Math.max(0, Math.min(draggingTable.x, floorPlanCanvas.width - draggingTable.width));
                draggingTable.y = Math.max(0, Math.min(draggingTable.y, floorPlanCanvas.height - draggingTable.height));

                drawFloorPlan();
            }
        });

        floorPlanCanvas.addEventListener('touchend', () => {
            draggingTable = null;
        });

        // ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ä¿å­˜ãƒœã‚¿ãƒ³
        document.getElementById('save-floor-plan').addEventListener('click', async () => {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€æ–°ã®x, yåº§æ¨™ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
            try {
                const response = await fetch('/api/tables/save_positions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tables: tablesData.map(t => ({ id: t.id, x: t.x, y: t.y })) })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
                } else {
                    showToast('ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                }
            } catch (error) {
                console.error('Error saving floor plan:', error);
                showToast('ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        });
    });

    /**
     * ãƒ•ãƒ­ã‚¢ãƒ—ãƒ©ãƒ³ã‚’æç”»ã—ã¾ã™ã€‚
     */
    function drawFloorPlan() {
        ctx.clearRect(0, 0, floorPlanCanvas.width, floorPlanCanvas.height); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢

        tablesData.forEach(table => {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
            ctx.fillStyle = '#667eea'; // ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼
            ctx.fillRect(table.x, table.y, table.width, table.height);
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 2;
            ctx.strokeRect(table.x, table.y, table.width, table.height);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸè‰²ã§æ ç·š
            if (table.status === 'occupied') {
                ctx.strokeStyle = colors.error; // èµ¤
            } else if (table.status === 'available') {
                ctx.strokeStyle = colors.success; // ç·‘
            } else if (table.status === 'cleaning') {
                ctx.strokeStyle = colors.warning; // ã‚ªãƒ¬ãƒ³ã‚¸
            }
            ctx.lineWidth = 4;
            ctx.strokeRect(table.x, table.y, table.width, table.height);


            // ãƒ†ãƒ¼ãƒ–ãƒ«åã®æç”»
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(table.name, table.x + table.width / 2, table.y + table.height / 2 - 10);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æç”»
            ctx.font = '12px Inter, sans-serif';
            ctx.fillText(
                table.status === 'available' ? 'ç©ºã' :
                table.status === 'occupied' ? 'ä½¿ç”¨ä¸­' :
                'æ¸…æƒä¸­',
                table.x + table.width / 2, table.y + table.height / 2 + 10
            );
        });
    }

    /**
     * QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™ã€‚
     * @param {number} tableId - ãƒ†ãƒ¼ãƒ–ãƒ«ID
     * @param {string} tableName - ãƒ†ãƒ¼ãƒ–ãƒ«å
     */
    function generateAndPrintQR(tableId, tableName) {
        // å®Ÿéš›ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«IDã«å¯¾å¿œã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€
        // ãã‚Œã‚’ä½¿ã£ã¦QRã‚³ãƒ¼ãƒ‰ã®URLã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        // ã“ã“ã§ã¯ä»®ã®URLã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        const qrUrl = `${window.location.origin}/qr/temp_token_for_${tableName}`; // ä»®ã®ãƒˆãƒ¼ã‚¯ãƒ³å

        const printWindow = window.open('', '_blank', 'width=400,height=400');
        printWindow.document.write(`
            <html>
            <head>
                <title>${tableName} QRã‚³ãƒ¼ãƒ‰</title>
                <style>
                    body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                    .qr-print-container { text-align: center; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
                    h1 { font-size: 24px; margin-bottom: 20px; }
                    canvas { border: 1px solid #eee; }
                </style>
            </head>
            <body>
                <div class="qr-print-container">
                    <h1>${tableName}</h1>
                    <canvas id="printQrCanvas"></canvas>
                    <p>ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æ³¨æ–‡ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/qrcode.js/qrcode.min.js"></script>
                <script>
                    window.onload = function() {
                        new QRCode(document.getElementById('printQrCanvas'), {
                            text: '${qrUrl}',
                            width: 256,
                            height: 256,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        setTimeout(() => {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        }, 500); // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å¾…ã£ã¦ã‹ã‚‰å°åˆ·
                    };
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     * @param {number} tableId - ãƒ†ãƒ¼ãƒ–ãƒ«ID
     * @param {string} tableName - ãƒ†ãƒ¼ãƒ–ãƒ«å
     * @param {string} currentStatus - ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     */
    function openStatusModal(tableId, tableName, currentStatus) {
        document.getElementById('status-modal-table-id').value = tableId;
        document.getElementById('status-modal-table-name').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
        document.getElementById('new-status').value = currentStatus;
        document.getElementById('update-status-form').action = `/admin/tables/update_status/${tableId}`;
        document.getElementById('status-modal').classList.remove('hidden');
    }

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeStatusModal() {
        document.getElementById('status-modal').classList.add('hidden');
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
     * @param {number} tableId - å‰Šé™¤ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ID
     * @param {string} tableName - å‰Šé™¤ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«å
     */
    function confirmDeleteTable(tableId, tableName) {
        document.getElementById('confirm-message').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${tableName}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (é–¢é€£ã™ã‚‹æ³¨æ–‡å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™)`;
        const confirmButton = document.getElementById('confirm-action-button');
        confirmButton.onclick = () => deleteTable(tableId);
        confirmButton.textContent = 'å‰Šé™¤'; // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œå‰Šé™¤ã€ã«è¨­å®š
        confirmButton.className = 'bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300';
        document.getElementById('confirm-dialog').classList.remove('hidden');
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
     */
    function closeConfirmDialog() {
        document.getElementById('confirm-dialog').classList.add('hidden');
    }

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
     * @param {number} tableId - å‰Šé™¤ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ID
     */
    async function deleteTable(tableId) {
        closeConfirmDialog(); // ã¾ãšãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        try {
            const response = await fetch(`/admin/tables/delete/${tableId}`); // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‰Šé™¤
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flaskã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã®å ´åˆ
            if (data.success) {
                showToast('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
                setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            } else {
                showToast('ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        } catch (error) {
            console.error('Error deleting table:', error);
            showToast('ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - 'success', 'error', 'info', 'warning'
     */
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-full opacity-0`;

        let bgColor;
        switch (type) {
            case 'success': bgColor = colors.success; break;
            case 'error': bgColor = colors.error; break;
            case 'info': bgColor = colors.primary; break;
            case 'warning': bgColor = colors.warning; break;
            default: bgColor = colors.gray; break;
        }
        toast.style.backgroundColor = bgColor;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        setTimeout(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 100);

        // è‡ªå‹•ã§æ¶ˆãˆã‚‹
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('translate-y-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
</script>

<style>
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .animate-scale-in {
        animation: scaleIn 0.3s ease-out forwards;
    }

    /* Canvasã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    #floorPlanCanvas {
        max-width: 100%;
        height: auto; /* é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ */
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
        body * {
            visibility: hidden;
        }
        .qr-print-container, .qr-print-container * {
            visibility: visible;
        }
        .qr-print-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    }
</style>
{% endblock %}
