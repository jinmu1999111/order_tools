{% extends 'layout.html' %}
{% block title %}卓管理{% endblock %}
{% block extra_css %}{% endblock %}
{% block content %}
<div class="container" style="max-width: 1200px;">
    <h1 class="mb-4" style="font-size: 2.5rem;">🪑 卓管理</h1>
    <div class="card mb-4">
        <div class="card-body">
            <form id="add-table-form" class="row g-2 align-items-end">
                <div class="col"><input type="text" id="new_table_name" class="form-control" placeholder="新しいテーブル名" required></div>
                <div class="col-auto"><button type="submit" class="btn btn-primary">追加</button></div>
            </form>
        </div>
    </div>
    <div class="row" id="tables-grid">
        {% for table in tables %}
        <div class="col-md-6 col-lg-4 mb-4" id="table-card-{{ table.id }}">
            <div class="card h-100">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ table.name }}</h5>
                    <button type="button" class="btn-close" onclick="deleteTable({{ table.id }})"></button>
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                    <div id="qrcode-{{ table.id }}" class="mb-2" style="min-height: 160px;"></div>
                    <small class="text-muted" id="expiry-{{ table.id }}">
                        {% if table.qr_token_expiry %}{{ table.qr_token_expiry.astimezone(JST).strftime('有効期限: %H:%M') }}{% endif %}
                    </small>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshToken({{ table.id }})">更新</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="enlargeQR('{{ table.name }}', '{{ table.active_qr_token if table.active_qr_token else 'None' }}')">拡大</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div class="modal fade" id="qr-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="qr-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body d-flex justify-content-center" id="qr-modal-body"></div></div></div></div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    const handleApiError = async (response) => {
        if (response.status === 401) {
            alert('セッションが切れました。再度ログインしてください。');
            window.location.href = '/login';
            return true;
        }
        // ここでエラーメッセージをより詳細に取得・表示する
        try {
            const errorData = await response.json();
            alert(`エラー: ${errorData.message || '不明なエラーが発生しました。'}`);
        } catch (e) {
            alert('エラーが発生しました。');
        }
        return true;
    };

    function generateQRCode(containerId, token, size = 150) {
        const qrContainer = document.getElementById(containerId);
        if (!qrContainer) return;
        qrContainer.innerHTML = '';
        if (token && token !== 'None') { // トークンが有効な場合にのみQRコードを生成
            new QRCode(qrContainer, { text: `${window.location.origin}/qr/${token}`, width: size, height: size, correctLevel: QRCode.CorrectLevel.H });
        } else {
            // QRコードがない場合のプレースホルダーなど
            qrContainer.innerHTML = '<div class="text-muted small">QR未生成</div>';
        }
    }

    // 新しいテーブルカードを生成して追加する関数
    function addTableCard(table) {
        const tablesGrid = document.getElementById('tables-grid');
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-6 col-lg-4 mb-4';
        colDiv.id = `table-card-${table.id}`;

        const expiryText = table.expiry ? `有効期限: ${new Date(table.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}` : '';
        const tokenForEnlarge = table.token ? `'${table.token}'` : `'None'`; // enlargeQRに渡すトークン

        colDiv.innerHTML = `
            <div class="card h-100">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">${table.name}</h5>
                    <button type="button" class="btn-close" onclick="deleteTable(${table.id})"></button>
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                    <div id="qrcode-${table.id}" class="mb-2" style="min-height: 160px;"></div>
                    <small class="text-muted" id="expiry-${table.id}">
                        ${expiryText}
                    </small>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshToken(${table.id})">更新</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="enlargeQR('${table.name}', ${tokenForEnlarge})">拡大</button>
                    </div>
                </div>
            </div>
        `;
        tablesGrid.appendChild(colDiv);
        generateQRCode(`qrcode-${table.id}`, table.token); // 新しく追加されたテーブルのQRコードを生成
    }


    async function refreshToken(tableId) {
        try {
            const response = await fetch(`/api/qr/generate/${tableId}`, { method: 'POST' });
            if (await handleApiError(response)) return; // awaitを追加
            const data = await response.json();
            if (!response.ok || !data.success) {
                alert(data.message || 'QRコードの更新に失敗しました。');
                return;
            }
            generateQRCode(`qrcode-${tableId}`, data.token);
            document.getElementById(`expiry-${tableId}`).textContent = `有効期限: ${new Date(data.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}`;
            const card = document.getElementById(`table-card-${tableId}`);
            const tableName = card.querySelector('h5').textContent;
            card.querySelector(`[onclick^="enlargeQR"]`).setAttribute('onclick', `enlargeQR('${tableName}', '${data.token}')`);
        } catch(error) { alert(error.message); }
    }
    async function deleteTable(tableId) {
        if (!confirm('本当にこのテーブルを削除しますか？')) return;
        try {
            const response = await fetch(`/api/tables/${tableId}`, { method: 'DELETE' });
            if (await handleApiError(response)) return; // awaitを追加
            if (!response.ok) {
                alert('テーブルの削除に失敗しました。');
                return;
            }
            document.getElementById(`table-card-${tableId}`).remove();
        } catch (error) { alert(error.message); }
    }
    document.getElementById('add-table-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('new_table_name').value;
        try {
            const response = await fetch('/api/tables', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            if (await handleApiError(response)) return; // awaitを追加
            const data = await response.json();
            if (!response.ok || !data.success) {
                alert(data.message || 'テーブルの追加に失敗しました。');
                return;
            }
            addTableCard(data); // ページリロードなしでテーブルを追加
            document.getElementById('new_table_name').value = ''; // フォームをクリア
        } catch (error) { alert(error.message); }
    });
    function enlargeQR(tableName, token) {
        if (!token || token === 'None') { alert('先にQRコードを生成・更新してください。'); return; }
        document.getElementById('qr-modal-title').textContent = `${tableName} QRコード`;
        generateQRCode('qr-modal-body', token, 300);
        new bootstrap.Modal(document.getElementById('qr-modal')).show();
    }
    document.addEventListener('DOMContentLoaded', () => {
        {% for table in tables %}
            // 初期表示時にactive_qr_tokenが存在すればQRコードを生成
            generateQRCode('qrcode-{{ table.id }}', '{{ table.active_qr_token if table.active_qr_token else 'None' }}');
        {% endfor %}
    });
</script>
{% endblock %}