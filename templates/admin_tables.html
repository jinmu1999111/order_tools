{% extends 'layout.html' %}
{% block title %}卓管理{% endblock %}

{% block extra_css %}
<style>
    .page-container { max-width: 1200px; margin: 0 auto; }
    .card-header h2 { font-size: 1.8rem; margin-bottom: 0; }
    
    .table-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .table-card .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .qr-code-container {
        width: 150px;
        height: 150px;
        margin: 1rem auto;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .qr-expiry {
        font-size: 0.8rem;
        color: var(--color-secondary);
    }

    #qr-enlarge-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8); display: none; align-items: center;
        justify-content: center; z-index: 1050;
    }
    #qr-enlarge-modal.show { display: flex; }
    .qr-enlarge-content { background: white; padding: 2rem; border-radius: 12px; text-align: center; }
    .qr-enlarge-code { width: 80vw; max-width: 400px; height: 80vw; max-height: 400px; margin: 1rem auto; }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <h1 class="mb-4" style="font-size: 2.5rem;">🪑 卓管理</h1>

    <div class="card mb-4">
        <div class="card-header bg-transparent border-0 pt-3">
            <h2>新しいテーブルを追加</h2>
        </div>
        <div class="card-body">
            <form id="add-table-form" class="row g-3 align-items-end">
                <div class="col">
                    <label for="table-name" class="form-label">テーブル名</label>
                    <input type="text" id="table-name" name="name" required class="form-control">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">追加</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row" id="table-grid">
        {% for table in tables %}
        <div class="col-12 col-md-6 col-lg-4 mb-4" id="table-card-{{ table.id }}">
            <div class="card table-card">
                <div class="card-body text-center">
                    <div>
                        <h3 class="card-title">{{ table.name }}</h3>
                        <div class="qr-code-container">
                            <div id="qrcode-{{ table.id }}"></div>
                        </div>
                        <p class="qr-expiry" id="expiry-{{ table.id }}">
                            {% if table.qr_token_expiry %}
                                有効期限: {{ table.qr_token_expiry.strftime('%H:%M') }}
                            {% else %}
                                QR未生成
                            {% endif %}
                        </p>
                    </div>
                    <div class="mt-3">
                        <div class="btn-group w-100 mb-2">
                            <button class="btn btn-outline-secondary" onclick="enlargeQR('{{ table.name }}', '{{ table.active_qr_token }}')">拡大</button>
                            <button class="btn btn-outline-secondary" onclick="printQR('{{ table.name }}', '{{ table.active_qr_token }}')">印刷</button>
                        </div>
                        <div class="btn-group w-100">
                            <button class="btn btn-primary" onclick="refreshToken({{ table.id }})">更新</button>
                            <button class="btn btn-danger" onclick="deleteTable({{ table.id }})">削除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="qr-enlarge-modal" onclick="this.classList.remove('show')">
    <div class="qr-enlarge-content">
        <h2 id="qr-enlarge-title"></h2>
        <div class="qr-enlarge-code" id="qr-enlarge-code"></div>
        <p class="text-muted mt-3">画面のどこかをタップして閉じる</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for table in tables %}
            {% if table.active_qr_token %}
                generateQRCode({{ table.id }}, '{{ table.active_qr_token }}');
            {% endif %}
        {% endfor %}
    });

    function generateQRCode(tableId, token, size = 150, containerId = `qrcode-${tableId}`) {
        const qrContainer = document.getElementById(containerId);
        if (!qrContainer) return;
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: `${window.location.origin}/qr/${token}`,
            width: size,
            height: size,
        });
    }

    async function refreshToken(tableId) {
        const response = await fetch(`/api/qr/generate/${tableId}`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            generateQRCode(tableId, data.token);
            document.getElementById(`expiry-${tableId}`).textContent = `有効期限: ${new Date(data.expiry).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}`;
            const card = document.getElementById(`table-card-${tableId}`);
            const tableName = card.querySelector('.card-title').textContent;
            card.querySelector(`[onclick^="enlargeQR"]`).setAttribute('onclick', `enlargeQR('${tableName}', '${data.token}')`);
            card.querySelector(`[onclick^="printQR"]`).setAttribute('onclick', `printQR('${tableName}', '${data.token}')`);
        } else {
            alert('QRコードの更新に失敗しました。');
        }
    }

    function enlargeQR(tableName, token) {
        if (!token) { alert('先にQRコードを更新してください。'); return; }
        const modal = document.getElementById('qr-enlarge-modal');
        document.getElementById('qr-enlarge-title').textContent = tableName;
        generateQRCode(null, token, 400, 'qr-enlarge-code');
        modal.classList.add('show');
    }

    function printQR(tableName, token) {
        if (!token) { alert('先にQRコードを更新してください。'); return; }
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>${tableName} QRコード</title></head>
            <body style="text-align:center; margin-top: 50px;">
                <h1>${tableName}</h1><div id="p_qr"></div>
                <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
                <script>
                    new QRCode(document.getElementById('p_qr'), { text: '${window.location.origin}/qr/${token}', width: 300, height: 300 });
                    setTimeout(() => { window.print(); window.close(); }, 500);
                <\/script>
            </body></html>
        `);
    }

    async function deleteTable(tableId) {
        if (!confirm('本当にこのテーブルを削除しますか？関連する注文履歴も全て削除されます。')) return;
        
        const response = await fetch(`/api/tables/${tableId}`, { method: 'DELETE' });
        if (response.ok) {
            document.getElementById(`table-card-${tableId}`).remove();
        } else {
            alert('テーブルの削除に失敗しました。');
        }
    }

    document.getElementById('add-table-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('table-name').value;
        if (!name) return;
        
        const response = await fetch('/api/tables', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('テーブルの追加に失敗しました。');
        }
    });
</script>
{% endblock %}
