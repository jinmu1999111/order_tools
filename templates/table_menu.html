{% extends "layout.html" %}
{% block title %}ご注文 - {{ table.name }}{% endblock %}

{% block extra_css %}
<style>
    .menu-header { text-align: center; padding: 2.5rem 1rem; margin-bottom: 1rem; }
    .menu-header h1 { font-size: 3.5rem; }
    .menu-header p { font-size: 1.2rem; color: var(--color-secondary); }
    .sort-options { text-align: center; margin-bottom: 2rem; }
    .floating-buttons { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .floating-btn {
        background: var(--color-text); color: white; width: 65px; height: 65px;
        border-radius: 50%; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border: 3px solid white; display: flex; align-items: center; justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="menu-header">
    <h1>メニュー</h1>
    <p>テーブル: {{ table.name }}</p>
</div>

<div class="sort-options">
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary" id="sort-category-btn" onclick="loadMenu('category')">カテゴリ順</button>
        <button type="button" class="btn btn-outline-primary" id="sort-popularity-btn" onclick="loadMenu('popularity')">人気順</button>
    </div>
</div>

<div class="container" id="menu-container">
    {% include '_menu_category.html' %}
</div>

<div class="floating-buttons">
    <button class="floating-btn btn" data-bs-toggle="modal" data-bs-target="#historyModal" onclick="fetchOrderHistory()">
        <i class="bi bi-receipt"></i>
    </button>
    <button class="floating-btn btn position-relative" data-bs-toggle="offcanvas" data-bs-target="#cart-sidebar" aria-controls="cart-sidebar">
        <i class="bi bi-basket3-fill"></i>
        <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" id="cart-count" style="display: none;"></span>
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
    let cart = {};
    const tableId = {{ table.id }};

    // ★★★ 修正点: メニューを動的に読み込む関数 ★★★
    async function loadMenu(sortBy) {
        const menuContainer = document.getElementById('menu-container');
        menuContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        const categoryBtn = document.getElementById('sort-category-btn');
        const popularityBtn = document.getElementById('sort-popularity-btn');

        // ボタンのスタイルを更新
        if (sortBy === 'popularity') {
            categoryBtn.classList.replace('btn-primary', 'btn-outline-primary');
            popularityBtn.classList.replace('btn-outline-primary', 'btn-primary');
        } else {
            popularityBtn.classList.replace('btn-primary', 'btn-outline-primary');
            categoryBtn.classList.replace('btn-outline-primary', 'btn-primary');
        }

        try {
            const response = await fetch(`/table/${tableId}/menu_partial?sort_by=${sortBy}`);
            const html = await response.text();
            menuContainer.innerHTML = html;
        } catch (error) {
            console.error('Failed to load menu:', error);
            menuContainer.innerHTML = '<p class="text-center text-danger">メニューの読み込みに失敗しました。</p>';
        }
    }


    // 既存のJavaScript関数 (changeQuantity, addToCartなど)
    function changeQuantity(itemId, change) {
        // この関数はDOMに依存するため、イベント委譲を使うように変更
        const qtyEl = document.getElementById(`qty-${itemId}`);
        if (!qtyEl) return;
        let qty = parseInt(qtyEl.textContent) + change;
        if (qty < 0) qty = 0;
        qtyEl.textContent = qty;
    }

    function addToCart(itemId) {
        const qtyEl = document.getElementById(`qty-${itemId}`);
        if (!qtyEl) return;
        const qty = parseInt(qtyEl.textContent);
        if (qty === 0) return;

        const itemEl = document.querySelector(`.menu-item[data-item-id="${itemId}"]`);
        if(!itemEl) return;
        
        const name = itemEl.dataset.itemName;
        const price = parseInt(itemEl.dataset.itemPrice);
        
        if (cart[itemId]) {
            cart[itemId].quantity += qty;
        } else {
            cart[itemId] = { name, price, quantity: qty };
        }

        qtyEl.textContent = 0;
        updateCartDisplay();
    }
    
    // (updateCartDisplay, submitOrder, fetchOrderHistoryは変更なし)
    // ...
</script>
{% endblock %}