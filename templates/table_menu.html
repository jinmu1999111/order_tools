{% extends "layout.html" %}
{% block title %}{{ table.name }} - æ³¨æ–‡{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-6">
        <h2 class="mb-3">ğŸ—’ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        {% for category, items in categorized_menu.items()|sort %}
        <h4 class="mt-4">{{ category }}</h4>
        <div class="list-group">
            {% for item in items %}
            <button type="button" class="list-group-item list-group-item-action" onclick='addToCart({{ item|tojson|safe }})'>
                {{ item.name }}
                <span class="float-end fw-bold">{{ item.price }}å††</span>
            </button>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div class="col-md-6">
        <div class="position-sticky" style="top: 80px;">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="h5 card-title">ä»Šå›ã®æ³¨æ–‡ï¼ˆã‚«ãƒ¼ãƒˆï¼‰</h3>
                    <ul id="cart-list" class="list-group list-group-flush"></ul>
                    <button id="submit-btn" class="btn btn-success w-100 mt-3" onclick="submitOrder()">
                        <i class="bi bi-send"></i> ã“ã®å†…å®¹ã§æ³¨æ–‡ã‚’é€ä¿¡ã™ã‚‹
                    </button>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="h5 card-title">ğŸ“‹ æ³¨æ–‡çŠ¶æ³</h3>
                    <ul id="order-list" class="list-group list-group-flush"></ul>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <h4 class="h5 mb-0">ãŠä¼šè¨ˆåˆè¨ˆ:</h4>
                        <h4 class="h5 mb-0" id="total-price">0å††</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const TABLE_ID = {{ table.id }};
    let cart = [];

    // ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ 
    function addToCart(item) {
        cart.push(item);
        updateCartDisplay();
    }

    // ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºã¨ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateCartDisplay() {
        const cartList = document.getElementById('cart-list');
        const submitBtn = document.getElementById('submit-btn');
        cartList.innerHTML = '';

        if (cart.length === 0) {
            cartList.innerHTML = '<li class="list-group-item text-muted">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</li>';
            if (submitBtn) {
                submitBtn.disabled = true; // ã‚«ãƒ¼ãƒˆãŒç©ºãªã‚‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            }
        } else {
            if (submitBtn) {
                submitBtn.disabled = false; // ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            }
            cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `${item.name} <span class="float-end">${item.price}å††</span>`;
                cartList.appendChild(li);
            });
        }
    }

    // æ³¨æ–‡ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    async function submitOrder() {
        if (cart.length === 0) {
            alert('ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        const response = await fetch('/api/order/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: TABLE_ID, cart: cart })
        });
        if (response.ok) {
            cart = [];
            updateCartDisplay();
            updateOrderStatus();
        } else {
            alert('æ³¨æ–‡ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    }

    // ç¢ºå®šæ¸ˆã¿ã®æ³¨æ–‡çŠ¶æ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤º
    async function updateOrderStatus() {
        const response = await fetch(`/api/table_status/${TABLE_ID}`);
        const data = await response.json();
        const orderList = document.getElementById('order-list');
        orderList.innerHTML = '';
        data.orders.forEach(order => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            let statusBadge = '';
            if (order.status === 'pending') {
                statusBadge = '<span class="badge bg-warning text-dark">èª¿ç†ä¸­</span>';
            } else {
                statusBadge = '<span class="badge bg-success">æä¾›æ¸ˆ</span>';
            }
            li.innerHTML = `${order.name} ${statusBadge}`;
            orderList.appendChild(li);
        });
        document.getElementById('total-price').textContent = `${data.total_price}å††`;
    }

    // åˆæœŸè¡¨ç¤ºã¨è‡ªå‹•æ›´æ–°
    document.addEventListener('DOMContentLoaded', () => {
        updateCartDisplay();
        updateOrderStatus();
        setInterval(updateOrderStatus, 10000);
    });
</script>
{% endblock %}