{% extends 'layout.html' %}
{% block title %}æ¡ˆå†…ç®¡ç†{% endblock %}
{% block extra_css %}{% endblock %}
{% block content %}
<div class="container" style="max-width: 800px;">
    <h1 class="mb-4" style="font-size: 2.5rem;">ğŸ’â€â™€ï¸ æ¡ˆå†…ç®¡ç†</h1>
    <div class="card">
        <div class="card-body">
            <p class="text-muted">ãŠå®¢æ§˜ã‚’ã”æ¡ˆå†…ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«åã¨äººæ•°ã‚’å…¥åŠ›ã—ã¦ã€30åˆ†é–“æœ‰åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
            <form id="guidance-form">
                <div class="mb-3">
                    <label for="table_name" class="form-label">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
                    <input type="text" class="form-control" id="table_name" placeholder="ä¾‹: 5ç•ªãƒ†ãƒ¼ãƒ–ãƒ«, ãƒ†ãƒ©ã‚¹å¸­A" required>
                </div>
                <div class="mb-3">
                    <label for="guest_count" class="form-label">äººæ•°</label>
                    <input type="number" class="form-control" id="guest_count" value="1" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">QRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</button>
            </form>
        </div>
    </div>
    <div id="qr-result-area" class="mt-4" style="display: none;">
        <h3 id="qr-title" class="text-center"></h3>
        <div id="generated-qr-code" class="p-3 bg-white rounded shadow-sm mx-auto" style="width: fit-content;"></div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    document.getElementById('guidance-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const tableName = document.getElementById('table_name').value;
        const guestCount = document.getElementById('guest_count').value;
        try {
            const response = await fetch('/api/guidance/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: tableName, guest_count: guestCount })
            });
            if (response.status === 401) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.message || 'QRã‚³ãƒ¼ãƒ‰ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            document.getElementById('qr-title').textContent = `${data.table_name}æ§˜ QRã‚³ãƒ¼ãƒ‰`;
            const qrContainer = document.getElementById('generated-qr-code');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, { text: `${window.location.origin}/qr/${data.token}`, width: 250, height: 250 });
            document.getElementById('qr-result-area').style.display = 'block';
        } catch (error) {
            alert(error.message);
        }
    });
</script>
{% endblock %}