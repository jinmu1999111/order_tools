{% extends 'layout.html' %}
{% block title %}案内管理{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    document.getElementById('guidance-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const tableName = document.getElementById('table_name').value;
        const guestCount = document.getElementById('guest_count').value;

        try {
            const response = await fetch('/api/guidance/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: tableName, guest_count: guestCount })
            });

            // ★★★ 修正点: 401エラー（セッション切れ）のハンドリングを追加 ★★★
            if (response.status === 401) {
                alert('セッションが切れました。再度ログインしてください。');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('QRコードの発行に失敗しました。サーバーエラーが発生した可能性があります。');
            }

            const data = await response.json();

            if (data.success) {
                const resultCard = document.getElementById('qr-result-card');
                const qrContainer = document.getElementById('generated-qr-code');
                const titleEl = document.getElementById('qr-result-title');
                
                titleEl.textContent = `${data.table_name}様 QRコード`;
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: `${window.location.origin}/qr/${data.token}`,
                    width: 250,
                    height: 250
                });
                resultCard.style.display = 'block';
            } else {
                alert(data.message || 'エラーが発生しました。');
            }
        } catch (error) {
            alert(error.message);
        }
    });
</script>
{% endblock %}