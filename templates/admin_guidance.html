{% extends 'layout.html' %}
{% block title %}ãŠå®¢æ§˜ã®ã”æ¡ˆå†…{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .card-header h2 {
        font-size: 1.8rem;
        margin-bottom: 0;
    }
    #qr-result-card {
        display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
    }
    #generated-qr-code {
        width: 100%;
        max-width: 250px;
        height: auto;
        aspect-ratio: 1 / 1;
        margin: 1rem auto;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <h1 class="mb-4" style="font-size: 2.5rem;">ğŸ’â€â™€ï¸ ãŠå®¢æ§˜ã®ã”æ¡ˆå†…</h1>

    <div class="card mb-4">
        <div class="card-header bg-transparent border-0 pt-3">
            <h2>QRã‚³ãƒ¼ãƒ‰ç™ºè¡Œ</h2>
        </div>
        <div class="card-body">
            <p class="card-text text-muted">ãŠå®¢æ§˜ã‚’ã”æ¡ˆå†…ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«åã¨äººæ•°ã‚’å…¥åŠ›ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã™ã€‚æœªç™»éŒ²ã®ãƒ†ãƒ¼ãƒ–ãƒ«åã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
            <form id="guidance-form" class="row g-3 align-items-end">
                <div class="col-12 col-md">
                    <label for="table_name" class="form-label">ãƒ†ãƒ¼ãƒ–ãƒ«å</label>
                    <input type="text" id="table_name" name="table_name" class="form-control" placeholder="ä¾‹: çª“éš›2ç•ªå¸­" required>
                </div>
                <div class="col-12 col-md-4">
                    <label for="guest_count" class="form-label">äººæ•°</label>
                    <input type="number" id="guest_count" name="guest_count" class="form-control" value="1" min="1" required>
                </div>
                <div class="col-12 col-md-auto">
                    <button type="submit" class="btn btn-primary w-100">ç™ºè¡Œ</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card" id="qr-result-card">
        <div class="card-body text-center">
            <h3 id="qr-result-title"></h3>
            <div id="generated-qr-code"></div>
            <p class="text-muted">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ãŠå®¢æ§˜ã«æç¤ºã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    document.getElementById('guidance-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const tableName = document.getElementById('table_name').value;
        const guestCount = document.getElementById('guest_count').value;

        try {
            const response = await fetch('/api/guidance/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: tableName, guest_count: guestCount })
            });

            if (!response.ok) {
                throw new Error('QRã‚³ãƒ¼ãƒ‰ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            const data = await response.json();

            if (data.success) {
                const resultCard = document.getElementById('qr-result-card');
                const qrContainer = document.getElementById('generated-qr-code');
                const titleEl = document.getElementById('qr-result-title');
                
                titleEl.textContent = `${data.table_name}æ§˜ QRã‚³ãƒ¼ãƒ‰`;
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: `${window.location.origin}/qr/${data.token}`,
                    width: 250,
                    height: 250
                });
                resultCard.style.display = 'block';
            } else {
                alert(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        } catch (error) {
            alert(error.message);
        }
    });
</script>
{% endblock %}
