{% extends 'layout.html' %}

{% block title %}„É°„Éã„É•„ÉºÁÆ°ÁêÜ{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">üçî „É°„Éã„É•„ÉºÁÆ°ÁêÜ</h1>

    <!-- „É°„Éã„É•„ÉºËøΩÂä†„Éï„Ç©„Éº„É† -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Êñ∞„Åó„ÅÑ„É°„Éã„É•„Éº„ÇíËøΩÂä†</h2>
        <form id="add-menu-form" action="{{ url_for('add_menu_item') }}" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="md:col-span-1">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">„É°„Éã„É•„ÉºÂêç</label>
                <input type="text" id="name" name="name" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">‰æ°Ê†º (¬•)</label>
                <input type="number" id="price" name="price" required min="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">„Ç´„ÉÜ„Ç¥„É™</label>
                <input type="text" id="category" name="category" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition duration-300 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> ËøΩÂä†
                </button>
            </div>
        </form>
    </div>

    <!-- „É°„Éã„É•„Éº‰∏ÄË¶ß„Å®ÁÆ°ÁêÜÊ©üËÉΩ -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">„É°„Éã„É•„Éº‰∏ÄË¶ß</h2>

        <!-- „Éï„Ç£„É´„Çø„Éº„ÉªÊ§úÁ¥¢Ê©üËÉΩ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="w-full md:w-1/3 relative">
                <input type="text" id="menu-search" placeholder="„É°„Éã„É•„ÉºÂêç„ÅßÊ§úÁ¥¢..." class="w-full p-2 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="w-full md:w-1/3">
                <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">ÂÖ®„Å¶„ÅÆ„Ç´„ÉÜ„Ç¥„É™</option>
                    {% set categories = menu_items | map(attribute='category') | unique | list %}
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-full md:w-1/3 text-right">
                <button id="export-csv" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300 mr-2">
                    <i class="fas fa-file-csv mr-2"></i> CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
                <button id="import-csv" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-300">
                    <i class="fas fa-file-import mr-2"></i> CSV„Ç§„É≥„Éù„Éº„Éà
                </button>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            „É°„Éã„É•„ÉºÂêç
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ‰æ°Ê†º
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            „Ç´„ÉÜ„Ç¥„É™
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ë°®Á§∫Áä∂ÊÖã
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Êìç‰Ωú
                        </th>
                    </tr>
                </thead>
                <tbody id="menu-table-body" class="bg-white divide-y divide-gray-200">
                    {% for item in menu_items %}
                    <tr data-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.price }}" data-category="{{ item.category }}" data-active="{{ item.active }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 editable" data-field="name">{{ item.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 editable" data-field="price">¬•{{ item.price | int }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 editable" data-field="category">{{ item.category }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if item.active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if item.active %}Ë°®Á§∫‰∏≠{% else %}ÈùûË°®Á§∫{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="toggleMenuItem({{ item.id }})" class="text-blue-600 hover:text-blue-900 mr-3 transition duration-150">
                                <i class="fas fa-eye{% if not item.active %}-slash{% endif %}"></i> Ë°®Á§∫ÂàáÊõø
                            </button>
                            <button onclick="openEditModal({{ item.id }}, '{{ item.name }}', {{ item.price }}, '{{ item.category }}')" class="text-indigo-600 hover:text-indigo-900 mr-3 transition duration-150">
                                <i class="fas fa-edit"></i> Á∑®ÈõÜ
                            </button>
                            <button onclick="confirmDelete({{ item.id }}, '{{ item.name }}')" class="text-red-600 hover:text-red-900 transition duration-150">
                                <i class="fas fa-trash-alt"></i> ÂâäÈô§
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
<div id="edit-menu-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-scale-in">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">„É°„Éã„É•„Éº„ÇíÁ∑®ÈõÜ</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-item-id">
            <div class="mb-4">
                <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">„É°„Éã„É•„ÉºÂêç</label>
                <input type="text" id="edit-name" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="mb-4">
                <label for="edit-price" class="block text-sm font-medium text-gray-700 mb-1">‰æ°Ê†º (¬•)</label>
                <input type="number" id="edit-price" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="mb-6">
                <label for="edit-category" class="block text-sm font-medium text-gray-700 mb-1">„Ç´„ÉÜ„Ç¥„É™</label>
                <input type="text" id="edit-category" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="submit" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-primary-dark transition duration-300">‰øùÂ≠ò</button>
            </div>
        </form>
    </div>
</div>

<!-- Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
<div id="confirm-dialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Á¢∫Ë™ç</h2>
        <p id="confirm-message" class="text-gray-700 mb-6">Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeConfirmDialog()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">„Ç≠„É£„É≥„Çª„É´</button>
            <button type="button" id="confirm-action-button" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300">ÂâäÈô§</button>
        </div>
    </div>
</div>

<script>
    // „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà„ÅÆÂÆöÁæ©
    const colors = {
        primary: '#667eea',
        secondary: '#ff6b6b',
        success: '#2ed573',
        warning: '#ffa502',
        error: '#ff4757',
        gray: '#e2e8f0'
    };

    document.addEventListener('DOMContentLoaded', function() {
        // „Éï„Ç£„É´„Çø„Éº„Å®Ê§úÁ¥¢Ê©üËÉΩ
        const menuSearch = document.getElementById('menu-search');
        const categoryFilter = document.getElementById('category-filter');
        const menuTableBody = document.getElementById('menu-table-body');

        function filterMenuItems() {
            const searchText = menuSearch.value.toLowerCase();
            const selectedCategory = categoryFilter.value.toLowerCase();

            Array.from(menuTableBody.children).forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const category = row.dataset.category.toLowerCase();

                const matchesSearch = name.includes(searchText);
                const matchesCategory = selectedCategory === '' || category === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        menuSearch.addEventListener('input', filterMenuItems);
        categoryFilter.addEventListener('change', filterMenuItems);

        // „Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜÊ©üËÉΩ
        menuTableBody.addEventListener('dblclick', function(event) {
            const target = event.target;
            if (target.classList.contains('editable')) {
                const originalText = target.textContent;
                const field = target.dataset.field;
                const itemId = target.closest('tr').dataset.id;

                const input = document.createElement('input');
                input.type = (field === 'price') ? 'number' : 'text';
                input.value = (field === 'price') ? parseInt(originalText.replace('¬•', '')) : originalText;
                input.className = 'w-full p-1 border border-blue-300 rounded-md focus:outline-none';

                target.innerHTML = '';
                target.appendChild(input);
                input.focus();

                input.addEventListener('blur', async function() {
                    const newValue = input.value;
                    if (newValue !== originalText) {
                        try {
                            const response = await fetch('/api/menu/update', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    id: itemId,
                                    field: field,
                                    value: newValue
                                })
                            });
                            const data = await response.json();
                            if (data.success) {
                                target.textContent = (field === 'price') ? `¬•${parseInt(newValue).toLocaleString()}` : newValue;
                                showToast('„É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
                                // „Éá„Éº„ÇøÂ±ûÊÄß„ÇÇÊõ¥Êñ∞
                                target.closest('tr').dataset[field] = (field === 'price') ? parseInt(newValue) : newValue;
                            } else {
                                target.textContent = originalText; // Â§±Êïó„Åó„Åü„ÇâÂÖÉ„Å´Êàª„Åô
                                showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                            }
                        } catch (error) {
                            console.error('Error updating menu item:', error);
                            target.textContent = originalText;
                            showToast('„É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                        }
                    } else {
                        target.textContent = originalText;
                    }
                });
            }
        });

        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ
        document.getElementById('export-csv').addEventListener('click', function() {
            const rows = Array.from(menuTableBody.children);
            let csvContent = "„É°„Éã„É•„ÉºÂêç,‰æ°Ê†º,„Ç´„ÉÜ„Ç¥„É™,Ë°®Á§∫Áä∂ÊÖã\n";

            rows.forEach(row => {
                const name = row.dataset.name;
                const price = row.dataset.price;
                const category = row.dataset.category;
                const active = row.dataset.active === 'true' ? 'Ë°®Á§∫‰∏≠' : 'ÈùûË°®Á§∫';
                csvContent += `${name},${price},${category},${active}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'menu_items.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('„É°„Éã„É•„Éº„Éá„Éº„Çø„ÇíCSV„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
        });

        // CSV„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ („Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„Éà„É™„Ç¨„Éº)
        document.getElementById('import-csv').addEventListener('click', function() {
            document.getElementById('csv-file-input').click();
        });

        // CSV„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
        document.getElementById('csv-file-input').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showToast('CSV„Éï„Ç°„Ç§„É´„ÅåÁ©∫„Åß„Åô„ÄÇ', 'warning');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                if (!headers.includes('„É°„Éã„É•„ÉºÂêç') || !headers.includes('‰æ°Ê†º') || !headers.includes('„Ç´„ÉÜ„Ç¥„É™')) {
                    showToast('CSV„Éò„ÉÉ„ÉÄ„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ„Äå„É°„Éã„É•„ÉºÂêç,‰æ°Ê†º,„Ç´„ÉÜ„Ç¥„É™„Äç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ', 'error');
                    return;
                }

                const itemsToImport = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row: ${lines[i]}`);
                        continue;
                    }
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index].trim();
                    });

                    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!item['„É°„Éã„É•„ÉºÂêç'] || !item['‰æ°Ê†º'] || !item['„Ç´„ÉÜ„Ç¥„É™'] || isNaN(parseInt(item['‰æ°Ê†º']))) {
                        showToast(`CSV„Éï„Ç°„Ç§„É´„ÅÆË°å ${i + 1} „Å´ÁÑ°Âäπ„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`, 'warning');
                        continue;
                    }

                    itemsToImport.push({
                        name: item['„É°„Éã„É•„ÉºÂêç'],
                        price: parseInt(item['‰æ°Ê†º']),
                        category: item['„Ç´„ÉÜ„Ç¥„É™']
                    });
                }

                if (itemsToImport.length > 0) {
                    try {
                        const response = await fetch('/api/menu/import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ items: itemsToImport })
                        });
                        const data = await response.json();
                        if (data.success) {
                            showToast(`${data.count} ‰ª∂„ÅÆ„É°„Éã„É•„Éº„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`, 'success');
                            setTimeout(() => location.reload(), 1500); // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„Éá„Éº„Çø„ÇíË°®Á§∫
                        } else {
                            showToast('CSV„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                        }
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        showToast('CSV„Ç§„É≥„Éù„Éº„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                    }
                } else {
                    showToast('„Ç§„É≥„Éù„Éº„Éà„Åô„ÇãÊúâÂäπ„Å™„É°„Éã„É•„Éº„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'warning');
                }
            };
            reader.readAsText(file);
        });

        // „Éï„Ç©„Éº„É†„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        document.getElementById('add-menu-form').addEventListener('submit', function(event) {
            const name = document.getElementById('name').value.trim();
            const price = document.getElementById('price').value.trim();
            const category = document.getElementById('category').value.trim();

            if (!name || !price || !category) {
                showToast('ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                event.preventDefault(); // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„Çí„Ç≠„É£„É≥„Çª„É´
            } else if (isNaN(parseInt(price)) || parseInt(price) < 0) {
                showToast('‰æ°Ê†º„ÅØ0‰ª•‰∏ä„ÅÆÊï∞ÂÄ§„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                event.preventDefault();
            }
        });

        document.getElementById('edit-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const itemId = document.getElementById('edit-item-id').value;
            const name = document.getElementById('edit-name').value.trim();
            const price = document.getElementById('edit-price').value.trim();
            const category = document.getElementById('edit-category').value.trim();

            if (!name || !price || !category) {
                showToast('ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                return;
            }
            if (isNaN(parseInt(price)) || parseInt(price) < 0) {
                showToast('‰æ°Ê†º„ÅØ0‰ª•‰∏ä„ÅÆÊï∞ÂÄ§„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/menu/update_full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: itemId,
                        name: name,
                        price: parseInt(price),
                        category: category
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('„É°„Éã„É•„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
                    closeEditModal();
                    setTimeout(() => location.reload(), 500); // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„Éá„Éº„Çø„ÇíË°®Á§∫
                } else {
                    showToast('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                }
            } catch (error) {
                console.error('Error updating menu item:', error);
                showToast('„É°„Éã„É•„ÉºÊÉÖÂ†±„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        });
    });

    /**
     * „É°„Éã„É•„ÉºË°®Á§∫Áä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà
     * @param {number} itemId - „É°„Éã„É•„ÉºID
     */
    async function toggleMenuItem(itemId) {
        try {
            const response = await fetch(`/admin/menu/toggle/${itemId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flask„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÅåJSON„ÅÆÂ†¥Âêà
            if (data.success) {
                showToast('Ë°®Á§∫Áä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü„ÄÇ', 'info');
                setTimeout(() => location.reload(), 500); // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„Éá„Éº„Çø„ÇíË°®Á§∫
            } else {
                showToast('Ë°®Á§∫Áä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        } catch (error) {
            console.error('Error toggling menu item:', error);
            showToast('Ë°®Á§∫Áä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
        }
    }

    /**
     * Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
     * @param {number} id - „É°„Éã„É•„ÉºID
     * @param {string} name - „É°„Éã„É•„ÉºÂêç
     * @param {number} price - ‰æ°Ê†º
     * @param {string} category - „Ç´„ÉÜ„Ç¥„É™
     */
    function openEditModal(id, name, price, category) {
        document.getElementById('edit-item-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-price').value = price;
        document.getElementById('edit-category').value = category;
        document.getElementById('edit-menu-modal').classList.remove('hidden');
    }

    /**
     * Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
     */
    function closeEditModal() {
        document.getElementById('edit-menu-modal').classList.add('hidden');
    }

    /**
     * ÂâäÈô§Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åè
     * @param {number} itemId - ÂâäÈô§„Åô„Çã„É°„Éã„É•„ÉºID
     * @param {string} itemName - ÂâäÈô§„Åô„Çã„É°„Éã„É•„ÉºÂêç
     */
    function confirmDelete(itemId, itemName) {
        document.getElementById('confirm-message').textContent = `„Äå${itemName}„Äç„ÇíÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`;
        const confirmButton = document.getElementById('confirm-action-button');
        confirmButton.onclick = () => deleteMenuItem(itemId);
        confirmButton.textContent = 'ÂâäÈô§'; // „Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Çí„ÄåÂâäÈô§„Äç„Å´Ë®≠ÂÆö
        confirmButton.className = 'bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300';
        document.getElementById('confirm-dialog').classList.remove('hidden');
    }

    /**
     * ÂâäÈô§Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
     */
    function closeConfirmDialog() {
        document.getElementById('confirm-dialog').classList.add('hidden');
    }

    /**
     * „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÇíÂâäÈô§
     * @param {number} itemId - ÂâäÈô§„Åô„Çã„É°„Éã„É•„ÉºID
     */
    async function deleteMenuItem(itemId) {
        closeConfirmDialog(); // „Åæ„Åö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
        try {
            const response = await fetch(`/admin/menu/delete/${itemId}`); // GET„É™„ÇØ„Ç®„Çπ„Éà„ÅßÂâäÈô§
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flask„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„ÅåJSON„ÅÆÂ†¥Âêà
            if (data.success) {
                showToast('„É°„Éã„É•„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
                setTimeout(() => location.reload(), 500); // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„Éá„Éº„Çø„ÇíË°®Á§∫
            } else {
                showToast('„É°„Éã„É•„Éº„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        } catch (error) {
            console.error('Error deleting menu item:', error);
            showToast('„É°„Éã„É•„Éº„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
        }
    }

    /**
     * „Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ
     * @param {string} message - Ë°®Á§∫„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏
     * @param {string} type - 'success', 'error', 'info', 'warning'
     */
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-full opacity-0`;

        let bgColor;
        switch (type) {
            case 'success': bgColor = colors.success; break;
            case 'error': bgColor = colors.error; break;
            case 'info': bgColor = colors.primary; break;
            case 'warning': bgColor = colors.warning; break;
            default: bgColor = colors.gray; break;
        }
        toast.style.backgroundColor = bgColor;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // „Éï„Çß„Éº„Éâ„Ç§„É≥
        setTimeout(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 100);

        // Ëá™Âãï„ÅßÊ∂à„Åà„Çã
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('translate-y-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
</script>

<style>
    /* „É¢„Éº„ÉÄ„É´Ë°®Á§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .animate-scale-in {
        animation: scaleIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}
