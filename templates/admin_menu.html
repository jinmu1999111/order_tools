{% extends 'layout.html' %}

{% block title %}ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ” ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h1>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">æ–°ã—ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </h2>
        <form id="add-menu-form" action="{{ url_for('add_menu_item') }}" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="md:col-span-1">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</label>
                <input type="text" id="name" name="name" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">ä¾¡æ ¼ (Â¥)</label>
                <input type="number" id="price" name="price" required min="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                <input type="text" id="category" name="category" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="md:col-span-1">
                <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition duration-300 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> è¿½åŠ 
                </button>
            </div>
        </form>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã¨ç®¡ç†æ©Ÿèƒ½ -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</h2>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢æ©Ÿèƒ½ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
            <div class="w-full md:w-1/3 relative">
                <input type="text" id="menu-search" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã§æ¤œç´¢..." class="w-full p-2 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="w-full md:w-1/3">
                <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                    {% set categories = menu_items | map(attribute='category') | unique | list %}
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-full md:w-1/3 text-right">
                <button id="export-csv" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300 mr-2">
                    <i class="fas fa-file-csv mr-2"></i> CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button id="import-csv" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-300">
                    <i class="fas fa-file-import mr-2"></i> CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ä¾¡æ ¼
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ã‚«ãƒ†ã‚´ãƒª
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            è¡¨ç¤ºçŠ¶æ…‹
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ
                        </th>
                    </tr>
                </thead>
                <tbody id="menu-table-body" class="bg-white divide-y divide-gray-200">
                    {% for item in menu_items %}
                    <tr data-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.price }}" data-category="{{ item.category }}" data-active="{{ item.active }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 editable" data-field="name">{{ item.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 editable" data-field="price">Â¥{{ item.price | int }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 editable" data-field="category">{{ item.category }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if item.active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if item.active %}è¡¨ç¤ºä¸­{% else %}éè¡¨ç¤º{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="toggleMenuItem({{ item.id }})" class="text-blue-600 hover:text-blue-900 mr-3 transition duration-150">
                                <i class="fas fa-eye{% if not item.active %}-slash{% endif %}"></i> è¡¨ç¤ºåˆ‡æ›¿
                            </button>
                            <button onclick="openEditModal({{ item.id }}, '{{ item.name }}', {{ item.price }}, '{{ item.category }}')" class="text-indigo-600 hover:text-indigo-900 mr-3 transition duration-150">
                                <i class="fas fa-edit"></i> ç·¨é›†
                            </button>
                            <button onclick="confirmDelete({{ item.id }}, '{{ item.name }}')" class="text-red-600 hover:text-red-900 transition duration-150">
                                <i class="fas fa-trash-alt"></i> å‰Šé™¤
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-menu-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-scale-in">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç·¨é›†</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-item-id">
            <div class="mb-4">
                <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</label>
                <input type="text" id="edit-name" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="mb-4">
                <label for="edit-price" class="block text-sm font-medium text-gray-700 mb-1">ä¾¡æ ¼ (Â¥)</label>
                <input type="number" id="edit-price" min="0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="mb-6">
                <label for="edit-category" class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                <input type="text" id="edit-category" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-primary-dark transition duration-300">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="confirm-dialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ç¢ºèª</h2>
        <p id="confirm-message" class="text-gray-700 mb-6">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeConfirmDialog()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" id="confirm-action-button" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300">å‰Šé™¤</button>
        </div>
    </div>
</div>

<script>
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã®å®šç¾©
    const colors = {
        primary: '#667eea',
        secondary: '#ff6b6b',
        success: '#2ed573',
        warning: '#ffa502',
        error: '#ff4757',
        gray: '#e2e8f0'
    };

    document.addEventListener('DOMContentLoaded', function() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨æ¤œç´¢æ©Ÿèƒ½
        const menuSearch = document.getElementById('menu-search');
        const categoryFilter = document.getElementById('category-filter');
        const menuTableBody = document.getElementById('menu-table-body');

        function filterMenuItems() {
            const searchText = menuSearch.value.toLowerCase();
            const selectedCategory = categoryFilter.value.toLowerCase();

            Array.from(menuTableBody.children).forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const category = row.dataset.category.toLowerCase();

                const matchesSearch = name.includes(searchText);
                const matchesCategory = selectedCategory === '' || category === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        menuSearch.addEventListener('input', filterMenuItems);
        categoryFilter.addEventListener('change', filterMenuItems);

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†æ©Ÿèƒ½
        menuTableBody.addEventListener('dblclick', function(event) {
            const target = event.target;
            if (target.classList.contains('editable')) {
                const originalText = target.textContent;
                const field = target.dataset.field;
                const itemId = target.closest('tr').dataset.id;

                const input = document.createElement('input');
                input.type = (field === 'price') ? 'number' : 'text';
                input.value = (field === 'price') ? parseInt(originalText.replace('Â¥', '')) : originalText;
                input.className = 'w-full p-1 border border-blue-300 rounded-md focus:outline-none';

                target.innerHTML = '';
                target.appendChild(input);
                input.focus();

                input.addEventListener('blur', async function() {
                    const newValue = input.value;
                    if (newValue !== originalText) {
                        try {
                            const response = await fetch('/api/menu/update', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    id: itemId,
                                    field: field,
                                    value: newValue
                                })
                            });
                            const data = await response.json();
                            if (data.success) {
                                target.textContent = (field === 'price') ? `Â¥${parseInt(newValue).toLocaleString()}` : newValue;
                                showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'success');
                                // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚‚æ›´æ–°
                                target.closest('tr').dataset[field] = (field === 'price') ? parseInt(newValue) : newValue;
                            } else {
                                target.textContent = originalText; // å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
                                showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                            }
                        } catch (error) {
                            console.error('Error updating menu item:', error);
                            target.textContent = originalText;
                            showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                        }
                    } else {
                        target.textContent = originalText;
                    }
                });
            }
        });

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        document.getElementById('export-csv').addEventListener('click', function() {
            const rows = Array.from(menuTableBody.children);
            let csvContent = "ãƒ¡ãƒ‹ãƒ¥ãƒ¼å,ä¾¡æ ¼,ã‚«ãƒ†ã‚´ãƒª,è¡¨ç¤ºçŠ¶æ…‹\n";

            rows.forEach(row => {
                const name = row.dataset.name;
                const price = row.dataset.price;
                const category = row.dataset.category;
                const active = row.dataset.active === 'true' ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º';
                csvContent += `${name},${price},${category},${active}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'menu_items.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'info');
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒˆãƒªã‚¬ãƒ¼)
        document.getElementById('import-csv').addEventListener('click', function() {
            document.getElementById('csv-file-input').click();
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        document.getElementById('csv-file-input').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ã€‚', 'warning');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                if (!headers.includes('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å') || !headers.includes('ä¾¡æ ¼') || !headers.includes('ã‚«ãƒ†ã‚´ãƒª')) {
                    showToast('CSVãƒ˜ãƒƒãƒ€ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼å,ä¾¡æ ¼,ã‚«ãƒ†ã‚´ãƒªã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
                    return;
                }

                const itemsToImport = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row: ${lines[i]}`);
                        continue;
                    }
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index].trim();
                    });

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!item['ãƒ¡ãƒ‹ãƒ¥ãƒ¼å'] || !item['ä¾¡æ ¼'] || !item['ã‚«ãƒ†ã‚´ãƒª'] || isNaN(parseInt(item['ä¾¡æ ¼']))) {
                        showToast(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œ ${i + 1} ã«ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚`, 'warning');
                        continue;
                    }

                    itemsToImport.push({
                        name: item['ãƒ¡ãƒ‹ãƒ¥ãƒ¼å'],
                        price: parseInt(item['ä¾¡æ ¼']),
                        category: item['ã‚«ãƒ†ã‚´ãƒª']
                    });
                }

                if (itemsToImport.length > 0) {
                    try {
                        const response = await fetch('/api/menu/import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ items: itemsToImport })
                        });
                        const data = await response.json();
                        if (data.success) {
                            showToast(`${data.count} ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`, 'success');
                            setTimeout(() => location.reload(), 1500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                        } else {
                            showToast('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                        }
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        showToast('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                    }
                } else {
                    showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æœ‰åŠ¹ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
                }
            };
            reader.readAsText(file);
        });

        // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('add-menu-form').addEventListener('submit', function(event) {
            const name = document.getElementById('name').value.trim();
            const price = document.getElementById('price').value.trim();
            const category = document.getElementById('category').value.trim();

            if (!name || !price || !category) {
                showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
                event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            } else if (isNaN(parseInt(price)) || parseInt(price) < 0) {
                showToast('ä¾¡æ ¼ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
                event.preventDefault();
            }
        });

        document.getElementById('edit-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const itemId = document.getElementById('edit-item-id').value;
            const name = document.getElementById('edit-name').value.trim();
            const price = document.getElementById('edit-price').value.trim();
            const category = document.getElementById('edit-category').value.trim();

            if (!name || !price || !category) {
                showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }
            if (isNaN(parseInt(price)) || parseInt(price) < 0) {
                showToast('ä¾¡æ ¼ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/menu/update_full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: itemId,
                        name: name,
                        price: parseInt(price),
                        category: category
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'success');
                    closeEditModal();
                    setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                } else {
                    showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                console.error('Error updating menu item:', error);
                showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        });
    });

    /**
     * ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
     * @param {number} itemId - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID
     */
    async function toggleMenuItem(itemId) {
        try {
            const response = await fetch(`/admin/menu/toggle/${itemId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flaskã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã®å ´åˆ
            if (data.success) {
                showToast('è¡¨ç¤ºçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚', 'info');
                setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            } else {
                showToast('è¡¨ç¤ºçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        } catch (error) {
            console.error('Error toggling menu item:', error);
            showToast('è¡¨ç¤ºçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     * @param {number} id - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID
     * @param {string} name - ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
     * @param {number} price - ä¾¡æ ¼
     * @param {string} category - ã‚«ãƒ†ã‚´ãƒª
     */
    function openEditModal(id, name, price, category) {
        document.getElementById('edit-item-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-price').value = price;
        document.getElementById('edit-category').value = category;
        document.getElementById('edit-menu-modal').classList.remove('hidden');
    }

    /**
     * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeEditModal() {
        document.getElementById('edit-menu-modal').classList.add('hidden');
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
     * @param {number} itemId - å‰Šé™¤ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID
     * @param {string} itemName - å‰Šé™¤ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
     */
    function confirmDelete(itemId, itemName) {
        document.getElementById('confirm-message').textContent = `ã€Œ${itemName}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
        const confirmButton = document.getElementById('confirm-action-button');
        confirmButton.onclick = () => deleteMenuItem(itemId);
        confirmButton.textContent = 'å‰Šé™¤'; // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œå‰Šé™¤ã€ã«è¨­å®š
        confirmButton.className = 'bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300';
        document.getElementById('confirm-dialog').classList.remove('hidden');
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
     */
    function closeConfirmDialog() {
        document.getElementById('confirm-dialog').classList.add('hidden');
    }

    /**
     * ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’å‰Šé™¤
     * @param {number} itemId - å‰Šé™¤ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID
     */
    async function deleteMenuItem(itemId) {
        closeConfirmDialog(); // ã¾ãšãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        try {
            const response = await fetch(`/admin/menu/delete/${itemId}`); // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‰Šé™¤
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flaskã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã®å ´åˆ
            if (data.success) {
                showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
                setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            } else {
                showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        } catch (error) {
            console.error('Error deleting menu item:', error);
            showToast('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - 'success', 'error', 'info', 'warning'
     */
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-full opacity-0`;

        let bgColor;
        switch (type) {
            case 'success': bgColor = colors.success; break;
            case 'error': bgColor = colors.error; break;
            case 'info': bgColor = colors.primary; break;
            case 'warning': bgColor = colors.warning; break;
            default: bgColor = colors.gray; break;
        }
        toast.style.backgroundColor = bgColor;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        setTimeout(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 100);

        // è‡ªå‹•ã§æ¶ˆãˆã‚‹
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('translate-y-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
</script>

<style>
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .animate-scale-in {
        animation: scaleIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}
