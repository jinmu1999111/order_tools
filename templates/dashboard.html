{% extends 'layout.html' %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“Š ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">ä»Šæ—¥ã®å£²ä¸Š</h2>
            <p class="text-4xl font-bold text-primary" id="today-sales">Â¥0</p>
            <p class="text-sm text-gray-500">å‰æ—¥æ¯”: <span id="sales-change" class="text-green-500">--</span></p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in delay-100">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">ä»Šæ—¥ã®æ³¨æ–‡æ•°</h2>
            <p class="text-4xl font-bold text-secondary" id="order-count">0</p>
            <p class="text-sm text-gray-500">å‰æ—¥æ¯”: <span id="order-change" class="text-red-500">--</span></p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in delay-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">ãƒ†ãƒ¼ãƒ–ãƒ«ç¨¼åƒä¸­</h2>
            <p class="text-4xl font-bold text-green-500" id="occupied-tables">0</p>
            <p class="text-sm text-gray-500">å…¨ãƒ†ãƒ¼ãƒ–ãƒ«æ•°: <span id="total-tables">0</span></p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in delay-300">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">å¹³å‡å®¢å˜ä¾¡</h2>
            <p class="text-4xl font-bold text-blue-500" id="avg-spend">Â¥0</p>
            <p class="text-sm text-gray-500">éå»7æ—¥é–“å¹³å‡: <span id="avg-spend-7day">--</span></p>
        </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6 animate-fade-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">å£²ä¸Šãƒˆãƒ¬ãƒ³ãƒ‰ (æ—¥åˆ¥ãƒ»æœˆåˆ¥)</h2>
            <div class="flex justify-end mb-4">
                <button id="sales-chart-daily" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition duration-300 mr-2">æ—¥åˆ¥</button>
                <button id="sales-chart-monthly" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-300">æœˆåˆ¥</button>
            </div>
            <canvas id="salesChart" class="w-full h-80"></canvas>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in delay-400">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <ul id="popular-items-list" class="divide-y divide-gray-200">
                <!-- äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
            </ul>
        </div>
    </div>

    <!-- æœ€è¿‘ã®æ³¨æ–‡ä¸€è¦§ -->
    <div class="bg-white rounded-lg shadow-md p-6 animate-fade-in delay-500">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">æœ€è¿‘ã®æ³¨æ–‡</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ³¨æ–‡ID
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ãƒ†ãƒ¼ãƒ–ãƒ«
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ä¾¡æ ¼
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ™‚é–“
                        </th>
                    </tr>
                </thead>
                <tbody id="recent-orders-list" class="bg-white divide-y divide-gray-200">
                    <!-- æœ€è¿‘ã®æ³¨æ–‡ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã®å®šç¾©
    const colors = {
        primary: '#667eea',
        secondary: '#ff6b6b',
        success: '#2ed573',
        warning: '#ffa502',
        error: '#ff4757',
        gray: '#e2e8f0'
    };

    let salesChart; // Chart.jsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

    document.addEventListener('DOMContentLoaded', function() {
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚§ãƒƒãƒã¨è¡¨ç¤º
        fetchDashboardData();
        fetchSalesData('daily'); // åˆæœŸè¡¨ç¤ºã¯æ—¥åˆ¥å£²ä¸Š

        // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–° (ä¾‹: 30ç§’ã”ã¨)
        setInterval(fetchDashboardData, 30000);
        // å£²ä¸Šã‚°ãƒ©ãƒ•ã®åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('sales-chart-daily').addEventListener('click', () => {
            fetchSalesData('daily');
            document.getElementById('sales-chart-daily').classList.add('bg-primary', 'text-white');
            document.getElementById('sales-chart-daily').classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('sales-chart-monthly').classList.remove('bg-primary', 'text-white');
            document.getElementById('sales-chart-monthly').classList.add('bg-gray-200', 'text-gray-700');
        });
        document.getElementById('sales-chart-monthly').addEventListener('click', () => {
            fetchSalesData('monthly');
            document.getElementById('sales-chart-monthly').classList.add('bg-primary', 'text-white');
            document.getElementById('sales-chart-monthly').classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('sales-chart-daily').classList.remove('bg-primary', 'text-white');
            document.getElementById('sales-chart-daily').classList.add('bg-gray-200', 'text-gray-700');
        });
    });

    /**
     * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä¸»è¦çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰ãƒ•ã‚§ãƒƒãƒã—ã€è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/stats/dashboard');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Dashboard Data:", data);

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
            document.getElementById('today-sales').textContent = `Â¥${data.today_sales.toLocaleString()}`;
            document.getElementById('order-count').textContent = data.order_count.toLocaleString();

            const totalTables = Object.values(data.table_stats).reduce((sum, count) => sum + count, 0);
            document.getElementById('occupied-tables').textContent = data.table_stats.occupied || 0;
            document.getElementById('total-tables').textContent = totalTables;

            // å¹³å‡å®¢å˜ä¾¡ã¯ã€ä»Šæ—¥ã®å£²ä¸Šã¨æ³¨æ–‡æ•°ã‹ã‚‰ç°¡æ˜“çš„ã«ç®—å‡º
            const avgSpend = data.order_count > 0 ? data.today_sales / data.order_count : 0;
            document.getElementById('avg-spend').textContent = `Â¥${Math.round(avgSpend).toLocaleString()}`;

            // äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æ›´æ–°
            const popularItemsList = document.getElementById('popular-items-list');
            popularItemsList.innerHTML = ''; // ã‚¯ãƒªã‚¢
            if (data.popular_items && data.popular_items.length > 0) {
                data.popular_items.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'py-3 flex items-center justify-between';
                    listItem.innerHTML = `
                        <span class="text-gray-900">${index + 1}. ${item.name}</span>
                        <span class="text-gray-600">${item.count} å›</span>
                    `;
                    popularItemsList.appendChild(listItem);
                });
            } else {
                popularItemsList.innerHTML = '<li class="text-gray-500 py-3">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
            }

            // æœ€è¿‘ã®æ³¨æ–‡ä¸€è¦§ã®æ›´æ–° (APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæœªå®šç¾©ã®ãŸã‚ã€ä»®ã®ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ç©º)
            // å®Ÿéš›ã«ã¯ /api/dashboard/recent-orders ã®ã‚ˆã†ãªAPIã‹ã‚‰å–å¾—
            const recentOrdersList = document.getElementById('recent-orders-list');
            recentOrdersList.innerHTML = ''; // ã‚¯ãƒªã‚¢

            // ä»®ã®ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            // if (data.recent_orders && data.recent_orders.length > 0) {
            //     data.recent_orders.forEach(order => {
            //         const row = document.createElement('tr');
            //         row.className = 'hover:bg-gray-100 transition duration-150';
            //         row.innerHTML = `
            //             <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
            //             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.table_name}</td>
            //             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.item_name}</td>
            //             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Â¥${order.item_price.toLocaleString()}</td>
            //             <td class="px-6 py-4 whitespace-nowrap text-sm">
            //                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getOrderStatusClass(order.status)}">
            //                     ${order.status_display}
            //                 </span>
            //             </td>
            //             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.timestamp}</td>
            //         `;
            //         recentOrdersList.appendChild(row);
            //     });
            // } else {
                recentOrdersList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">æœ€è¿‘ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            // }

        } catch (error) {
            console.error('Failed to fetch dashboard data:', error);
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãªã©ã®UIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            showToast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰ãƒ•ã‚§ãƒƒãƒã—ã€Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     * @param {string} period - 'daily' ã¾ãŸã¯ 'monthly'
     */
    async function fetchSalesData(period) {
        try {
            const response = await fetch(`/api/dashboard/sales?period=${period}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log("Sales Data:", data);

            const labels = data.labels;
            const salesData = data.sales;

            if (salesChart) {
                salesChart.destroy(); // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å£²ä¸Š (Â¥)',
                        data: salesData,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: colors.primary,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `å£²ä¸Š: Â¥${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Failed to fetch sales data:', error);
            showToast('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
     * @param {string} status - æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     * @returns {string} CSSã‚¯ãƒ©ã‚¹
     */
    function getOrderStatusClass(status) {
        switch (status) {
            case 'pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'cooking':
                return 'bg-blue-100 text-blue-800';
            case 'served':
                return 'bg-green-100 text-green-800';
            case 'cancelled':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    /**
     * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - 'success', 'error', 'info', 'warning'
     */
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-full opacity-0`;

        let bgColor;
        switch (type) {
            case 'success': bgColor = colors.success; break;
            case 'error': bgColor = colors.error; break;
            case 'info': bgColor = colors.primary; break;
            case 'warning': bgColor = colors.warning; break;
            default: bgColor = colors.gray; break;
        }
        toast.style.backgroundColor = bgColor;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        setTimeout(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 100);

        // è‡ªå‹•ã§æ¶ˆãˆã‚‹
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('translate-y-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
</script>
{% endblock %}
