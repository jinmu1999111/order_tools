{% extends 'layout.html' %}

{% block title %}æ³¨æ–‡å±¥æ­´ç®¡ç†{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“œ æ³¨æ–‡å±¥æ­´ç®¡ç†</h1>

    <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">æ³¨æ–‡æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="search-keyword" class="block text-sm font-medium text-gray-700 mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                <input type="text" id="search-keyword" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã€ãƒ†ãƒ¼ãƒ–ãƒ«å..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
                <label for="filter-table" class="block text-sm font-medium text-gray-700 mb-1">ãƒ†ãƒ¼ãƒ–ãƒ«ã§çµã‚Šè¾¼ã¿</label>
                <select id="filter-table" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«</option>
                    {% for table in tables %}
                    <option value="{{ table.name }}">{{ table.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§çµã‚Šè¾¼ã¿</label>
                <select id="filter-status" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                    <option value="pending">æ³¨æ–‡å—ä»˜</option>
                    <option value="cooking">èª¿ç†ä¸­</option>
                    <option value="served">æä¾›æ¸ˆ</option>
                    <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="filter-start-date" class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥</label>
                <input type="date" id="filter-start-date" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
                <label for="filter-end-date" class="block text-sm font-medium text-gray-700 mb-1">çµ‚äº†æ—¥</label>
                <input type="date" id="filter-end-date" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button id="reset-filters" class="bg-gray-400 text-white px-5 py-2 rounded-md hover:bg-gray-500 transition duration-300">
                <i class="fas fa-redo mr-2"></i> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
            </button>
            <button id="apply-filters" class="bg-primary text-white px-5 py-2 rounded-md hover:bg-primary-dark transition duration-300">
                <i class="fas fa-filter mr-2"></i> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            </button>
        </div>
    </div>

    <!-- æ³¨æ–‡å±¥æ­´ä¸€è¦§ -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">æ³¨æ–‡å±¥æ­´</h2>

        <div class="flex justify-end mb-4">
            <button id="export-csv" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300 mr-2">
                <i class="fas fa-file-csv mr-2"></i> CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button id="export-pdf" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300">
                <i class="fas fa-file-pdf mr-2"></i> PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="id">
                            æ³¨æ–‡ID <i class="fas fa-sort text-gray-400 ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="table_name">
                            ãƒ†ãƒ¼ãƒ–ãƒ« <i class="fas fa-sort text-gray-400 ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="item_price">
                            ä¾¡æ ¼ <i class="fas fa-sort text-gray-400 ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="status">
                            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ <i class="fas fa-sort text-gray-400 ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="timestamp">
                            æ³¨æ–‡æ—¥æ™‚ <i class="fas fa-sort text-gray-400 ml-1"></i>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ
                        </th>
                    </tr>
                </thead>
                <tbody id="order-history-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- æ³¨æ–‡å±¥æ­´ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
                </tbody>
            </table>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="flex justify-center items-center gap-2 mt-6" aria-label="Pagination">
            <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                å‰ã¸
            </button>
            <span id="page-info" class="text-gray-700 text-sm"></span>
            <button id="next-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                æ¬¡ã¸
            </button>
        </nav>
    </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-scale-in">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">æ³¨æ–‡è©³ç´°</h2>
        <div id="detail-content" class="text-gray-700 mb-6">
            <!-- è©³ç´°å†…å®¹ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
        </div>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeDetailModal()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">é–‰ã˜ã‚‹</button>
            <button type="button" id="refund-button" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300">
                <i class="fas fa-undo mr-2"></i> è¿”é‡‘/ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
    </div>
</div>

<!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="confirm-dialog" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-scale-in">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ç¢ºèª</h2>
        <p id="confirm-message" class="text-gray-700 mb-6">æœ¬å½“ã«å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeConfirmDialog()" class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400 transition duration-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button type="button" id="confirm-action-button" class="bg-red-600 text-white px-5 py-2 rounded-md hover:bg-red-700 transition duration-300">å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã®å®šç¾©
    const colors = {
        primary: '#667eea',
        secondary: '#ff6b6b',
        success: '#2ed573',
        warning: '#ffa502',
        error: '#ff4757',
        gray: '#e2e8f0'
    };

    let allOrders = []; // å…¨ã¦ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let filteredOrders = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
    let currentPage = 1;
    const itemsPerPage = 10; // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡¨ç¤ºæ•°
    let currentSortColumn = 'timestamp';
    let currentSortDirection = 'desc'; // 'asc' or 'desc'

    document.addEventListener('DOMContentLoaded', function() {
        fetchOrderHistory();

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ãƒœã‚¿ãƒ³
        document.getElementById('apply-filters').addEventListener('click', applyFiltersAndSort);
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        document.getElementById('reset-filters').addEventListener('click', resetFilters);

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderOrders();
            }
        });
        document.getElementById('next-page').addEventListener('click', () => {
            if (currentPage * itemsPerPage < filteredOrders.length) {
                currentPage++;
                renderOrders();
            }
        });

        // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        document.querySelectorAll('th[data-sort]').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    currentSortDirection = 'asc'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ˜‡é †
                }
                applyFiltersAndSort(); // ã‚½ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¦å†æç”»
            });
        });

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        document.getElementById('export-csv').addEventListener('click', exportCsv);
        // PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        document.getElementById('export-pdf').addEventListener('click', exportPdf);

        // è¿”é‡‘/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼‰
        document.getElementById('refund-button').addEventListener('click', function() {
            const orderId = this.dataset.orderId; // ã“ã®ãƒœã‚¿ãƒ³ã«æ³¨æ–‡IDã‚’ã‚»ãƒƒãƒˆã—ã¦ãŠã
            if (orderId) {
                confirmAction('ã“ã®æ³¨æ–‡ã‚’è¿”é‡‘/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ', () => processRefundCancel(orderId));
            }
        });
    });

    /**
     * æ³¨æ–‡å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰ãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
     */
    async function fetchOrderHistory() {
        try {
            const response = await fetch('/api/history/orders'); // æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æƒ³å®š
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allOrders = data.orders; // å…¨ã¦ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            applyFiltersAndSort(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚½ãƒ¼ãƒˆã‚’é©ç”¨ã—ã¦åˆæœŸè¡¨ç¤º
        } catch (error) {
            console.error('Failed to fetch order history:', error);
            showToast('æ³¨æ–‡å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚½ãƒ¼ãƒˆã‚’é©ç”¨ã—ã€æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function applyFiltersAndSort() {
        let tempOrders = [...allOrders]; // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„ã‚ˆã†ã«ã‚³ãƒ”ãƒ¼

        // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const keyword = document.getElementById('search-keyword').value.toLowerCase();
        const tableFilter = document.getElementById('filter-table').value;
        const statusFilter = document.getElementById('filter-status').value;
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        filteredOrders = tempOrders.filter(order => {
            const matchesKeyword = (order.item_name.toLowerCase().includes(keyword) || order.table_name.toLowerCase().includes(keyword));
            const matchesTable = tableFilter === '' || order.table_name === tableFilter;
            const matchesStatus = statusFilter === '' || order.status === statusFilter;

            // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let matchesDate = true;
            if (startDate) {
                const orderDate = new Date(order.timestamp.split('T')[0]); // YYYY-MM-DDå½¢å¼ã«å¤‰æ›
                const start = new Date(startDate);
                if (orderDate < start) matchesDate = false;
            }
            if (endDate) {
                const orderDate = new Date(order.timestamp.split('T')[0]);
                const end = new Date(endDate);
                if (orderDate > end) matchesDate = false;
            }

            return matchesKeyword && matchesTable && matchesStatus && matchesDate;
        });

        // 2. ã‚½ãƒ¼ãƒˆ
        filteredOrders.sort((a, b) => {
            let valA, valB;

            switch (currentSortColumn) {
                case 'id':
                    valA = a.id;
                    valB = b.id;
                    break;
                case 'table_name':
                    valA = a.table_name;
                    valB = b.table_name;
                    break;
                case 'item_price':
                    valA = a.item_price;
                    valB = b.item_price;
                    break;
                case 'status':
                    valA = a.status;
                    valB = b.status;
                    break;
                case 'timestamp':
                    valA = new Date(a.timestamp);
                    valB = new Date(b.timestamp);
                    break;
                default:
                    return 0;
            }

            if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        currentPage = 1; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆé©ç”¨å¾Œã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
        renderOrders();
    }

    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
     */
    function resetFilters() {
        document.getElementById('search-keyword').value = '';
        document.getElementById('filter-table').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-start-date').value = '';
        document.getElementById('filter-end-date').value = '';
        currentSortColumn = 'timestamp'; // ã‚½ãƒ¼ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
        currentSortDirection = 'desc';
        applyFiltersAndSort();
    }

    /**
     * æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æç”»ã—ã¾ã™ã€‚
     */
    function renderOrders() {
        const tableBody = document.getElementById('order-history-table-body');
        tableBody.innerHTML = ''; // ã‚¯ãƒªã‚¢

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const ordersToDisplay = filteredOrders.slice(startIndex, endIndex);

        if (ordersToDisplay.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">è©²å½“ã™ã‚‹æ³¨æ–‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            document.getElementById('page-info').textContent = '0ä»¶ / 0ãƒšãƒ¼ã‚¸';
            return;
        }

        ordersToDisplay.forEach(order => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-100 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.table_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.item_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Â¥${order.item_price.toLocaleString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getOrderStatusClass(order.status)}">
                        ${getOrderStatusDisplay(order.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.timestamp).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="openDetailModal(${order.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition duration-150">
                        <i class="fas fa-info-circle"></i> è©³ç´°
                    </button>
                    <button onclick="confirmAction('ã“ã®æ³¨æ–‡ã®å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ', () => clearOrderHistory(${order.id}))" class="text-red-600 hover:text-red-900 transition duration-150">
                        <i class="fas fa-eraser"></i> ã‚¯ãƒªã‚¢
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
        const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
        document.getElementById('page-info').textContent = `${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ (${filteredOrders.length} ä»¶)`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages || filteredOrders.length === 0;
    }

    /**
     * æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
     * @param {string} status - æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     * @returns {string} CSSã‚¯ãƒ©ã‚¹
     */
    function getOrderStatusClass(status) {
        switch (status) {
            case 'pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'cooking':
                return 'bg-blue-100 text-blue-800';
            case 'served':
                return 'bg-green-100 text-green-800';
            case 'cancelled':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    /**
     * æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºåã‚’è¿”ã—ã¾ã™ã€‚
     * @param {string} status - æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
     * @returns {string} è¡¨ç¤ºå
     */
    function getOrderStatusDisplay(status) {
        return {
            'pending': 'æ³¨æ–‡å—ä»˜',
            'cooking': 'èª¿ç†ä¸­',
            'served': 'æä¾›æ¸ˆ',
            'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        }[status] || status;
    }

    /**
     * è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
     * @param {number} orderId - æ³¨æ–‡ID
     */
    function openDetailModal(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showToast('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
            return;
        }

        const detailContent = document.getElementById('detail-content');
        detailContent.innerHTML = `
            <p><strong class="text-gray-900">æ³¨æ–‡ID:</strong> ${order.id}</p>
            <p><strong class="text-gray-900">ãƒ†ãƒ¼ãƒ–ãƒ«:</strong> ${order.table_name}</p>
            <p><strong class="text-gray-900">ãƒ¡ãƒ‹ãƒ¥ãƒ¼:</strong> ${order.item_name}</p>
            <p><strong class="text-gray-900">ä¾¡æ ¼:</strong> Â¥${order.item_price.toLocaleString()}</p>
            <p><strong class="text-gray-900">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span class="${getOrderStatusClass(order.status)} px-2 py-1 rounded-full text-xs">${getOrderStatusDisplay(order.status)}</span></p>
            <p><strong class="text-gray-900">æ³¨æ–‡æ—¥æ™‚:</strong> ${new Date(order.timestamp).toLocaleString('ja-JP')}</p>
            <p><strong class="text-gray-900">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</strong> ${order.session_id}</p>
        `;
        document.getElementById('refund-button').dataset.orderId = orderId; // è¿”é‡‘ãƒœã‚¿ãƒ³ã«IDã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('detail-modal').classList.remove('hidden');
    }

    /**
     * è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    function closeDetailModal() {
        document.getElementById('detail-modal').classList.add('hidden');
    }

    /**
     * æ³¨æ–‡å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚
     * @param {number} orderId - ã‚¯ãƒªã‚¢ã™ã‚‹æ³¨æ–‡ã®ID
     */
    async function clearOrderHistory(orderId) {
        closeConfirmDialog(); // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        try {
            // ã“ã®APIã¯ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹æƒ³å®šã§ã™ã€‚
            // å€‹åˆ¥ã®æ³¨æ–‡ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹APIãŒå¿…è¦ãªå ´åˆã¯ã€åˆ¥é€”å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚
            // ä¾‹: `/api/order/clear/${orderId}`
            // ä»Šå›ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”»é¢ã«ã‚ã‚‹`/admin/history/clear/<int:table_id>`ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€
            // æ³¨æ–‡IDã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«IDã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showToast('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            const tableId = order.table_id; // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã«table_idãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ä»®å®š

            const response = await fetch(`/admin/history/clear/${tableId}`, { method: 'POST' });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json(); // Flaskã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã®å ´åˆ
            if (data.success) {
                showToast(`ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${order.table_name}ã€ã®æ³¨æ–‡å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚`, 'success');
                setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            } else {
                showToast('æ³¨æ–‡å±¥æ­´ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        } catch (error) {
            console.error('Error clearing order history:', error);
            showToast('æ³¨æ–‡å±¥æ­´ã®ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * è¿”é‡‘/ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
     * @param {number} orderId - å‡¦ç†ã™ã‚‹æ³¨æ–‡ã®ID
     */
    async function processRefundCancel(orderId) {
        closeConfirmDialog(); // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        try {
            const response = await fetch('/api/order/update_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order_id: orderId, status: 'cancelled' }) // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«æ›´æ–°
            });
            const data = await response.json();
            if (data.success) {
                showToast('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'success');
                closeDetailModal();
                setTimeout(() => location.reload(), 500); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            } else {
                showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        } catch (error) {
            console.error('Error processing refund/cancel:', error);
            showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
        }
    }

    /**
     * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
     */
    function exportCsv() {
        let csvContent = "æ³¨æ–‡ID,ãƒ†ãƒ¼ãƒ–ãƒ«,ãƒ¡ãƒ‹ãƒ¥ãƒ¼,ä¾¡æ ¼,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,æ³¨æ–‡æ—¥æ™‚\n";
        filteredOrders.forEach(order => {
            const row = [
                order.id,
                order.table_name,
                order.item_name,
                order.item_price,
                getOrderStatusDisplay(order.status),
                new Date(order.timestamp).toLocaleString('ja-JP')
            ].map(item => `"${String(item).replace(/"/g, '""')}"`).join(','); // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¿ã€å†…éƒ¨ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'order_history.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('æ³¨æ–‡å±¥æ­´ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'info');
    }

    /**
     * PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
     */
    function exportPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFont('Inter', 'normal'); // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆæ—¥æœ¬èªå¯¾å¿œãƒ•ã‚©ãƒ³ãƒˆãŒå¿…è¦ï¼‰

        const tableColumn = ["æ³¨æ–‡ID", "ãƒ†ãƒ¼ãƒ–ãƒ«", "ãƒ¡ãƒ‹ãƒ¥ãƒ¼", "ä¾¡æ ¼", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", "æ³¨æ–‡æ—¥æ™‚"];
        const tableRows = [];

        filteredOrders.forEach(order => {
            const orderData = [
                order.id,
                order.table_name,
                order.item_name,
                `Â¥${order.item_price.toLocaleString()}`,
                getOrderStatusDisplay(order.status),
                new Date(order.timestamp).toLocaleString('ja-JP')
            ];
            tableRows.push(orderData);
        });

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 20,
            styles: {
                font: 'Inter', // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ãªã„ã¨æ–‡å­—åŒ–ã‘ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š
                fontSize: 8,
                cellPadding: 3,
                valign: 'middle',
                halign: 'left'
            },
            headStyles: {
                fillColor: [102, 126, 234], // primary color
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            columnStyles: {
                0: { cellWidth: 15 },
                1: { cellWidth: 20 },
                2: { cellWidth: 40 },
                3: { cellWidth: 20 },
                4: { cellWidth: 20 },
                5: { cellWidth: 45 }
            }
        });

        doc.save('order_history.pdf');
        showToast('æ³¨æ–‡å±¥æ­´ã‚’PDFã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'info');
    }

    /**
     * ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãæ±ç”¨é–¢æ•°
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {function} actionCallback - ç¢ºèªæ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     * @param {string} buttonText - ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'å®Ÿè¡Œ')
     * @param {string} buttonClass - ç¢ºèªãƒœã‚¿ãƒ³ã®CSSã‚¯ãƒ©ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'bg-red-600 text-white')
     */
    function confirmAction(message, actionCallback, buttonText = 'å®Ÿè¡Œ', buttonClass = 'bg-red-600 text-white') {
        document.getElementById('confirm-message').textContent = message;
        const confirmButton = document.getElementById('confirm-action-button');
        confirmButton.onclick = actionCallback;
        confirmButton.textContent = buttonText;
        confirmButton.className = `${buttonClass} px-5 py-2 rounded-md hover:opacity-90 transition duration-300`;
        document.getElementById('confirm-dialog').classList.remove('hidden');
    }

    /**
     * ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
     */
    function closeConfirmDialog() {
        document.getElementById('confirm-dialog').classList.add('hidden');
    }

    /**
     * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} type - 'success', 'error', 'info', 'warning'
     */
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            console.error('Toast container not found.');
            return;
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-full opacity-0`;

        let bgColor;
        switch (type) {
            case 'success': bgColor = colors.success; break;
            case 'error': bgColor = colors.error; break;
            case 'info': bgColor = colors.primary; break;
            case 'warning': bgColor = colors.warning; break;
            default: bgColor = colors.gray; break;
        }
        toast.style.backgroundColor = bgColor;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        setTimeout(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
        }, 100);

        // è‡ªå‹•ã§æ¶ˆãˆã‚‹
        setTimeout(() => {
            toast.classList.remove('translate-y-0', 'opacity-100');
            toast.classList.add('translate-y-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
</script>

<style>
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .animate-scale-in {
        animation: scaleIn 0.3s ease-out forwards;
    }
</style>
{% endblock %}
